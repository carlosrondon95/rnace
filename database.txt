-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.agenda_mes (
  anio integer NOT NULL,
  mes integer NOT NULL CHECK (mes >= 1 AND mes <= 12),
  abierto boolean NOT NULL DEFAULT false,
  CONSTRAINT agenda_mes_pkey PRIMARY KEY (anio, mes)
);
CREATE TABLE public.creditos_mensuales (
  usuario_id uuid NOT NULL,
  anio integer NOT NULL,
  mes integer NOT NULL,
  modalidad USER-DEFINED NOT NULL,
  cupo_mes smallint NOT NULL,
  consumidas smallint NOT NULL DEFAULT 0,
  recuperables smallint NOT NULL DEFAULT 0,
  carry_over_restante smallint NOT NULL DEFAULT 0,
  CONSTRAINT creditos_mensuales_pkey PRIMARY KEY (usuario_id, anio, mes, modalidad),
  CONSTRAINT creditos_mensuales_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES auth.users(id)
);
CREATE TABLE public.festivos (
  fecha date NOT NULL,
  descripcion text,
  CONSTRAINT festivos_pkey PRIMARY KEY (fecha)
);
CREATE TABLE public.horario_base_usuario (
  id bigint NOT NULL DEFAULT nextval('horario_base_usuario_id_seq'::regclass),
  usuario_id uuid NOT NULL,
  modalidad USER-DEFINED NOT NULL,
  dia_semana smallint NOT NULL CHECK (dia_semana >= 1 AND dia_semana <= 7),
  hora time without time zone NOT NULL,
  CONSTRAINT horario_base_usuario_pkey PRIMARY KEY (id),
  CONSTRAINT horario_base_usuario_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES auth.users(id)
);
CREATE TABLE public.horarios_base (
  id bigint NOT NULL DEFAULT nextval('horarios_base_id_seq'::regclass),
  modalidad USER-DEFINED NOT NULL,
  dia_semana smallint NOT NULL CHECK (dia_semana >= 1 AND dia_semana <= 7),
  hora time without time zone NOT NULL,
  capacidad smallint NOT NULL CHECK (capacidad >= 1 AND capacidad <= 64),
  CONSTRAINT horarios_base_pkey PRIMARY KEY (id)
);
CREATE TABLE public.invitaciones (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  email text,
  telefono text,
  rol text NOT NULL DEFAULT 'cliente'::text,
  codigo text NOT NULL UNIQUE,
  expira_en timestamp with time zone NOT NULL,
  usada boolean DEFAULT false,
  usada_en timestamp with time zone,
  creado_por uuid,
  creado_en timestamp with time zone DEFAULT now(),
  CONSTRAINT invitaciones_pkey PRIMARY KEY (id),
  CONSTRAINT invitaciones_creado_por_fkey FOREIGN KEY (creado_por) REFERENCES auth.users(id)
);
CREATE TABLE public.lista_espera (
  sesion_id bigint NOT NULL,
  usuario_id uuid NOT NULL,
  creado_en timestamp with time zone DEFAULT now(),
  CONSTRAINT lista_espera_pkey PRIMARY KEY (sesion_id, usuario_id),
  CONSTRAINT lista_espera_sesion_id_fkey FOREIGN KEY (sesion_id) REFERENCES public.sesiones(id),
  CONSTRAINT lista_espera_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES auth.users(id)
);
CREATE TABLE public.notificaciones (
  id bigint NOT NULL DEFAULT nextval('notificaciones_id_seq'::regclass),
  usuario_id uuid NOT NULL,
  tipo text NOT NULL,
  mensaje text,
  payload jsonb,
  leida boolean DEFAULT false,
  creado_en timestamp with time zone DEFAULT now(),
  sesion_id bigint,
  accion_url text,
  procesada boolean DEFAULT false,
  CONSTRAINT notificaciones_pkey PRIMARY KEY (id),
  CONSTRAINT notificaciones_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES auth.users(id),
  CONSTRAINT notificaciones_sesion_id_fkey FOREIGN KEY (sesion_id) REFERENCES public.sesiones(id),
  CONSTRAINT notificaciones_sesion_fk FOREIGN KEY (sesion_id) REFERENCES public.sesiones(id)
);
CREATE TABLE public.perfiles (
  id uuid NOT NULL,
  nombre text,
  telefono text,
  rol text NOT NULL DEFAULT 'cliente'::text,
  creado_en timestamp with time zone DEFAULT now(),
  actualizado_en timestamp with time zone DEFAULT now(),
  CONSTRAINT perfiles_pkey PRIMARY KEY (id),
  CONSTRAINT perfiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id)
);
CREATE TABLE public.plan_usuario (
  usuario_id uuid NOT NULL,
  activo boolean DEFAULT true,
  creado_en timestamp with time zone DEFAULT now(),
  actualizado_en timestamp with time zone DEFAULT now(),
  tipo_grupo USER-DEFINED,
  clases_focus_semana smallint DEFAULT 0 CHECK (clases_focus_semana >= 0 AND clases_focus_semana <= 7),
  clases_reducido_semana smallint DEFAULT 0 CHECK (clases_reducido_semana >= 0 AND clases_reducido_semana <= 7),
  recuperacion_focus_disponible boolean DEFAULT false,
  recuperacion_reducido_disponible boolean DEFAULT false,
  recuperacion_generada_en date,
  sesiones_fijas_mes_focus smallint,
  sesiones_fijas_mes_reducido smallint,
  tipo_cuota text DEFAULT 'semanal'::text,
  CONSTRAINT plan_usuario_pkey PRIMARY KEY (usuario_id)
);
CREATE TABLE public.reservas (
  id bigint NOT NULL DEFAULT nextval('reservas_id_seq'::regclass),
  sesion_id bigint NOT NULL,
  usuario_id uuid NOT NULL,
  estado USER-DEFINED NOT NULL DEFAULT 'activa'::estado_reserva,
  origen text DEFAULT 'normal'::text,
  recuperable boolean DEFAULT false,
  creada_en timestamp with time zone DEFAULT now(),
  cancelada_en timestamp with time zone,
  es_recuperacion boolean DEFAULT false,
  recuperacion_de_reserva_id bigint,
  cancelada_correctamente boolean DEFAULT false,
  CONSTRAINT reservas_pkey PRIMARY KEY (id),
  CONSTRAINT reservas_sesion_id_fkey FOREIGN KEY (sesion_id) REFERENCES public.sesiones(id),
  CONSTRAINT reservas_usuario_id_fkey FOREIGN KEY (usuario_id) REFERENCES auth.users(id),
  CONSTRAINT reservas_recuperacion_fk FOREIGN KEY (recuperacion_de_reserva_id) REFERENCES public.reservas(id)
);
CREATE TABLE public.sesiones (
  id bigint NOT NULL DEFAULT nextval('sesiones_id_seq'::regclass),
  fecha_inicio timestamp with time zone NOT NULL,
  fecha_fin timestamp with time zone NOT NULL,
  modalidad USER-DEFINED NOT NULL,
  capacidad smallint NOT NULL CHECK (capacidad >= 1 AND capacidad <= 64),
  cancelada boolean DEFAULT false,
  creado_en timestamp with time zone DEFAULT now(),
  actualizado_en timestamp with time zone DEFAULT now(),
  profesor_id uuid,
  CONSTRAINT sesiones_pkey PRIMARY KEY (id),
  CONSTRAINT sesiones_profesor_id_fkey FOREIGN KEY (profesor_id) REFERENCES auth.users(id)
);
CREATE TABLE public.usuarios (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  telefono character varying NOT NULL UNIQUE,
  password_hash text NOT NULL,
  nombre text,
  rol character varying DEFAULT 'cliente'::character varying CHECK (rol::text = ANY (ARRAY['cliente'::character varying, 'profesor'::character varying, 'admin'::character varying]::text[])),
  activo boolean DEFAULT true,
  creado_en timestamp with time zone DEFAULT now(),
  actualizado_en timestamp with time zone DEFAULT now(),
  CONSTRAINT usuarios_pkey PRIMARY KEY (id)
);