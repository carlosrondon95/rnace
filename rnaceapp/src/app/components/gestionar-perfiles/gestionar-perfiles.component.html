<!-- src/app/components/gestionar-perfiles/gestionar-perfiles.component.html -->

<main class="perfiles-page">
  <!-- Header -->
  <header class="page-header">
    <button class="btn-volver" (click)="volver()">
      <span class="material-symbols-rounded">arrow_back</span>
      Volver
    </button>
    <h1>Gestionar Perfiles</h1>
  </header>

  <!-- Barra de búsqueda y nuevo usuario -->
  <div class="toolbar">
    <div class="search-box">
      <span class="material-symbols-rounded search-icon">search</span>
      <input
        type="text"
        placeholder="Buscar por nombre o teléfono..."
        [ngModel]="busqueda()"
        (ngModelChange)="busqueda.set($event)"
      />
    </div>
    <button class="btn-nuevo" (click)="abrirModalNuevo()">
      <span class="material-symbols-rounded">person_add</span>
      Nuevo Usuario
    </button>
  </div>

  <!-- Filtros -->
  <div class="filtros-bar">
    <div class="filtros-grupo">
      <!-- Filtro por Rol -->
      <div class="filtro-item">
        <label for="filtro-rol">Rol</label>
        <select
          id="filtro-rol"
          [ngModel]="filtros().rol"
          (ngModelChange)="actualizarFiltro('rol', $event)"
        >
          <option value="todos">Todos</option>
          <option value="cliente">Cliente</option>
          <option value="profesor">Profesor</option>
          <option value="admin">Admin</option>
        </select>
      </div>

      <!-- Filtro por Estado -->
      <div class="filtro-item">
        <label for="filtro-estado">Estado</label>
        <select
          id="filtro-estado"
          [ngModel]="filtros().activo"
          (ngModelChange)="actualizarFiltro('activo', $event)"
        >
          <option value="todos">Todos</option>
          <option value="activo">Activos</option>
          <option value="inactivo">Inactivos</option>
        </select>
      </div>

      <!-- Filtro por Tipo de Grupo -->
      <div class="filtro-item">
        <label for="filtro-tipo-grupo">Tipo de grupo</label>
        <select
          id="filtro-tipo-grupo"
          [ngModel]="filtros().tipoGrupo"
          (ngModelChange)="actualizarFiltro('tipoGrupo', $event)"
        >
          <option value="todos">Todos</option>
          <option value="focus">Focus</option>
          <option value="reducido">Reducido</option>
          <option value="hibrido">Híbrido</option>
          <option value="especial">Especial</option>
        </select>
      </div>
    </div>

    <!-- Botón limpiar filtros -->
    <button class="btn-limpiar" *ngIf="hayFiltrosActivos()" (click)="limpiarFiltros()">
      <span class="material-symbols-rounded">filter_alt_off</span>
      Limpiar
    </button>
  </div>

  <!-- Estado de carga -->
  <div class="loading-state" *ngIf="cargando()">
    <div class="spinner"></div>
    <p>Cargando perfiles...</p>
  </div>

  <!-- Error -->
  <div class="error-state" *ngIf="error() && !cargando()">
    <span class="material-symbols-rounded">error</span>
    <p>{{ error() }}</p>
  </div>

  <!-- Lista de perfiles -->
  <div class="perfiles-list" *ngIf="!cargando() && !error()">
    <div class="perfiles-count">
      {{ usuariosFiltrados().length }} usuario{{ usuariosFiltrados().length !== 1 ? 's' : '' }}
      <span *ngIf="hayFiltrosActivos()" class="filtros-activos">(filtrado)</span>
    </div>

    <div
      class="perfil-card"
      *ngFor="let usuario of usuariosFiltrados()"
      [class.inactivo]="!usuario.activo"
    >
      <div class="perfil-avatar">
        <span class="material-symbols-rounded">person</span>
      </div>

      <div class="perfil-info">
        <div class="perfil-nombre">
          {{ usuario.nombre || 'Sin nombre' }}
          <span class="badge-inactivo" *ngIf="!usuario.activo">Inactivo</span>
        </div>
        <div class="perfil-telefono">
          <span class="material-symbols-rounded">phone</span>
          {{ usuario.telefono || 'Sin teléfono' }}
        </div>
      </div>

      <div class="perfil-meta">
        <span class="perfil-rol" [ngClass]="obtenerClaseRol(usuario.rol)">
          {{ usuario.rol }}
        </span>
        <span class="perfil-plan">
          {{ obtenerEtiquetaGrupo(usuario.plan) }}
        </span>
      </div>

      <div class="perfil-fecha">
        {{ formatearFecha(usuario.creado_en) }}
      </div>

      <button class="btn-editar" title="Editar perfil" (click)="abrirModalEditar(usuario)">
        <span class="material-symbols-rounded">edit</span>
      </button>
    </div>

    <!-- Sin resultados -->
    <div class="no-resultados" *ngIf="usuariosFiltrados().length === 0">
      <span class="material-symbols-rounded">person_off</span>
      <p *ngIf="busqueda() || hayFiltrosActivos()">
        No se encontraron usuarios con los filtros aplicados
      </p>
      <p *ngIf="!busqueda() && !hayFiltrosActivos()">No hay usuarios registrados</p>
      <button class="btn-limpiar-inline" *ngIf="hayFiltrosActivos()" (click)="limpiarFiltros()">
        Limpiar filtros
      </button>
    </div>
  </div>
</main>

<!-- Modal Crear/Editar Usuario -->
<div
  class="modal-overlay"
  *ngIf="mostrarModal()"
  role="dialog"
  aria-modal="true"
  aria-labelledby="modal-titulo"
>
  <button class="modal-backdrop" (click)="cerrarModal()" aria-label="Cerrar modal"></button>

  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modal-titulo">{{ modoEdicion() ? 'Editar Usuario' : 'Nuevo Usuario' }}</h2>
      <button class="btn-cerrar" (click)="cerrarModal()" aria-label="Cerrar">
        <span class="material-symbols-rounded">close</span>
      </button>
    </div>

    <div class="modal-body">
      <!-- Mensaje de éxito -->
      <div class="mensaje-exito" *ngIf="exitoModal()">
        <span class="material-symbols-rounded">check_circle</span>
        {{ exitoModal() }}
      </div>

      <!-- Formulario (solo si no hay éxito) -->
      <ng-container *ngIf="!exitoModal()">
        <div class="form-grid">
          <!-- Nombre -->
          <div class="form-group">
            <label for="nombre">Nombre *</label>
            <input
              id="nombre"
              type="text"
              [ngModel]="formulario().nombre"
              (ngModelChange)="actualizarCampo('nombre', $event)"
              placeholder="Juan"
            />
          </div>

          <!-- Apellidos -->
          <div class="form-group">
            <label for="apellidos">Apellidos</label>
            <input
              id="apellidos"
              type="text"
              [ngModel]="formulario().apellidos"
              (ngModelChange)="actualizarCampo('apellidos', $event)"
              placeholder="García López"
            />
          </div>

          <!-- Teléfono -->
          <div class="form-group">
            <label for="telefono">Teléfono * (usuario de acceso)</label>
            <input
              id="telefono"
              type="tel"
              [ngModel]="formulario().telefono"
              (ngModelChange)="actualizarCampo('telefono', $event)"
              placeholder="612345678"
              inputmode="numeric"
            />
          </div>

          <!-- Rol (solo en edición o si es necesario) -->
          <div class="form-group">
            <label for="rol">Rol</label>
            <select
              id="rol"
              [ngModel]="formulario().rol"
              (ngModelChange)="actualizarCampo('rol', $event)"
            >
              <option *ngFor="let r of roles" [value]="r.value">{{ r.label }}</option>
            </select>
          </div>

          <!-- Estado activo (solo en edición) -->
          <div class="form-group form-group--full" *ngIf="modoEdicion()">
            <label class="checkbox-label">
              <input
                type="checkbox"
                [checked]="formulario().activo"
                (change)="actualizarCampo('activo', $any($event.target).checked)"
              />
              <span class="checkbox-text">Usuario activo</span>
              <span class="checkbox-hint">Los usuarios inactivos no pueden iniciar sesión</span>
            </label>
          </div>

          <!-- Separador -->
          <div class="form-separator">
            <span>Plan de clases</span>
          </div>

          <!-- Tipo de grupo -->
          <div class="form-group form-group--full">
            <label for="tipoGrupo">Tipo de grupo *</label>
            <select
              id="tipoGrupo"
              [ngModel]="formulario().tipoGrupo"
              (ngModelChange)="actualizarCampo('tipoGrupo', $event)"
            >
              <option *ngFor="let tipo of tiposGrupo" [value]="tipo.value">
                {{ tipo.label }}
              </option>
            </select>
          </div>

          <!-- Clases Focus -->
          <div class="form-group" *ngIf="formulario().tipoGrupo !== 'reducido'">
            <label for="clasesFocus">Clases Focus / semana</label>
            <select
              id="clasesFocus"
              [ngModel]="formulario().clasesFocus"
              (ngModelChange)="actualizarCampo('clasesFocus', +$event)"
            >
              <option *ngFor="let n of clasesOptions" [ngValue]="n">{{ n }}</option>
            </select>
          </div>

          <!-- Clases Reducido -->
          <div class="form-group" *ngIf="formulario().tipoGrupo !== 'focus'">
            <label for="clasesReducido">Clases Reducido / semana</label>
            <select
              id="clasesReducido"
              [ngModel]="formulario().clasesReducido"
              (ngModelChange)="actualizarCampo('clasesReducido', +$event)"
            >
              <option *ngFor="let n of clasesOptions" [ngValue]="n">{{ n }}</option>
            </select>
          </div>

          <!-- Tipo de cuota (solo para especial) -->
          <div class="form-group" *ngIf="formulario().tipoGrupo === 'especial'">
            <label for="tipoCuota">Tipo de cuota</label>
            <select
              id="tipoCuota"
              [ngModel]="formulario().tipoCuota"
              (ngModelChange)="actualizarCampo('tipoCuota', $event)"
            >
              <option value="semanal">Por semana</option>
              <option value="mensual">Por mes</option>
            </select>
          </div>

          <!-- Separador Contraseña -->
          <div class="form-separator">
            <span>{{ modoEdicion() ? 'Cambiar contraseña (opcional)' : 'Contraseña' }}</span>
          </div>

          <!-- Contraseña -->
          <div class="form-group form-group--full">
            <label for="password-field">
              {{ modoEdicion() ? 'Nueva contraseña' : 'Contraseña * (para enviar al usuario)' }}
            </label>
            <div class="password-row">
              <input
                id="password-field"
                type="text"
                [value]="formulario().password"
                readonly
                [placeholder]="
                  modoEdicion()
                    ? 'Dejar vacío para no cambiar'
                    : 'Pulsa Generar para crear una contraseña'
                "
                class="password-input"
              />
              <button type="button" class="btn-generar" (click)="generarPassword()">
                <span class="material-symbols-rounded">autorenew</span>
                Generar
              </button>
              <button
                type="button"
                class="btn-copiar"
                (click)="copiarPassword()"
                [disabled]="!formulario().password"
                [class.copiada]="passwordCopiada()"
              >
                <span class="material-symbols-rounded">
                  {{ passwordCopiada() ? 'check' : 'content_copy' }}
                </span>
              </button>
            </div>
            <span class="password-hint" *ngIf="formulario().password">
              Copia esta contraseña y envíala al usuario por WhatsApp
            </span>
          </div>
        </div>

        <!-- Error -->
        <div class="mensaje-error" *ngIf="errorModal()" role="alert">
          <span class="material-symbols-rounded">error</span>
          {{ errorModal() }}
        </div>
      </ng-container>
    </div>

    <div class="modal-footer">
      <button class="btn-cancelar" (click)="cerrarModal()">
        {{ exitoModal() ? 'Cerrar' : 'Cancelar' }}
      </button>
      <button
        class="btn-guardar"
        (click)="guardarUsuario()"
        [disabled]="guardando() || !formularioValido() || !!exitoModal()"
        *ngIf="!exitoModal()"
      >
        <span class="material-symbols-rounded" *ngIf="!guardando()">save</span>
        <span class="spinner-small" *ngIf="guardando()"></span>
        {{ guardando() ? 'Guardando...' : modoEdicion() ? 'Guardar Cambios' : 'Crear Usuario' }}
      </button>
    </div>
  </div>
</div>
