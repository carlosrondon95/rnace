<!-- src/app/components/gestionar-perfiles/gestionar-perfiles.component.html -->

<main class="perfiles-page">
  <!-- Header -->
  <header class="page-header">
    <button class="btn-volver" (click)="volver()">
      <span class="material-symbols-rounded">arrow_back</span>
      Volver
    </button>
    <h1>Gestionar Perfiles</h1>
  </header>

  <!-- Barra de búsqueda y nuevo usuario -->
  <div class="toolbar">
    <div class="search-box">
      <span class="material-symbols-rounded search-icon">search</span>
      <input
        type="text"
        placeholder="Buscar por nombre, teléfono o rol..."
        [ngModel]="busqueda()"
        (ngModelChange)="busqueda.set($event)"
      />
    </div>
    <button class="btn-nuevo" (click)="abrirModalNuevo()">
      <span class="material-symbols-rounded">person_add</span>
      Nuevo Usuario
    </button>
  </div>

  <!-- Estado de carga -->
  <div class="loading-state" *ngIf="cargando()">
    <div class="spinner"></div>
    <p>Cargando perfiles...</p>
  </div>

  <!-- Error -->
  <div class="error-state" *ngIf="error() && !cargando()">
    <span class="material-symbols-rounded">error</span>
    <p>{{ error() }}</p>
  </div>

  <!-- Lista de perfiles -->
  <div class="perfiles-list" *ngIf="!cargando() && !error()">
    <div class="perfiles-count">
      {{ perfilesFiltrados().length }} usuario{{ perfilesFiltrados().length !== 1 ? 's' : '' }}
    </div>

    <div class="perfil-card" *ngFor="let perfil of perfilesFiltrados()">
      <div class="perfil-avatar">
        <span class="material-symbols-rounded">person</span>
      </div>

      <div class="perfil-info">
        <div class="perfil-nombre">{{ perfil.nombre || 'Sin nombre' }}</div>
        <div class="perfil-telefono">
          <span class="material-symbols-rounded">phone</span>
          {{ perfil.telefono || 'Sin teléfono' }}
        </div>
      </div>

      <div class="perfil-meta">
        <span class="perfil-rol" [ngClass]="obtenerClaseRol(perfil.rol)">
          {{ perfil.rol }}
        </span>
        <span class="perfil-plan">
          {{ obtenerEtiquetaGrupo(perfil.plan) }}
        </span>
      </div>

      <div class="perfil-fecha">
        {{ formatearFecha(perfil.creado_en) }}
      </div>

      <button class="btn-editar" title="Editar perfil">
        <span class="material-symbols-rounded">edit</span>
      </button>
    </div>

    <!-- Sin resultados -->
    <div class="no-resultados" *ngIf="perfilesFiltrados().length === 0">
      <span class="material-symbols-rounded">person_off</span>
      <p *ngIf="busqueda()">No se encontraron usuarios para "{{ busqueda() }}"</p>
      <p *ngIf="!busqueda()">No hay usuarios registrados</p>
    </div>
  </div>
</main>

<!-- Modal Nuevo Usuario -->
<div
  class="modal-overlay"
  *ngIf="mostrarModal()"
  role="dialog"
  aria-modal="true"
  aria-labelledby="modal-titulo"
>
  <!-- Botón invisible para cerrar al hacer clic fuera -->
  <button
    class="modal-backdrop"
    (click)="cerrarModal()"
    (keydown.escape)="cerrarModal()"
    aria-label="Cerrar modal"
  ></button>

  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modal-titulo">Nuevo Usuario</h2>
      <button class="btn-cerrar" (click)="cerrarModal()" aria-label="Cerrar">
        <span class="material-symbols-rounded">close</span>
      </button>
    </div>

    <div class="modal-body">
      <!-- Mensaje de éxito -->
      <div class="mensaje-exito" *ngIf="exitoModal()">
        <span class="material-symbols-rounded">check_circle</span>
        {{ exitoModal() }}
      </div>

      <!-- Formulario (solo si no hay éxito) -->
      <ng-container *ngIf="!exitoModal()">
        <div class="form-grid">
          <!-- Nombre -->
          <div class="form-group">
            <label for="nombre">Nombre *</label>
            <input
              id="nombre"
              type="text"
              [ngModel]="nuevoUsuario().nombre"
              (ngModelChange)="actualizarCampo('nombre', $event)"
              placeholder="Juan"
            />
          </div>

          <!-- Apellidos -->
          <div class="form-group">
            <label for="apellidos">Apellidos</label>
            <input
              id="apellidos"
              type="text"
              [ngModel]="nuevoUsuario().apellidos"
              (ngModelChange)="actualizarCampo('apellidos', $event)"
              placeholder="García López"
            />
          </div>

          <!-- Teléfono -->
          <div class="form-group form-group--full">
            <label for="telefono">Teléfono * (será su usuario de acceso)</label>
            <input
              id="telefono"
              type="tel"
              [ngModel]="nuevoUsuario().telefono"
              (ngModelChange)="actualizarCampo('telefono', $event)"
              placeholder="612345678"
              inputmode="numeric"
            />
          </div>

          <!-- Tipo de grupo -->
          <div class="form-group form-group--full">
            <label for="tipoGrupo">Tipo de grupo *</label>
            <select
              id="tipoGrupo"
              [ngModel]="nuevoUsuario().tipoGrupo"
              (ngModelChange)="actualizarCampo('tipoGrupo', $event)"
            >
              <option *ngFor="let tipo of tiposGrupo" [value]="tipo.value">
                {{ tipo.label }}
              </option>
            </select>
          </div>

          <!-- Clases Focus (visible si no es solo reducido) -->
          <div class="form-group" *ngIf="nuevoUsuario().tipoGrupo !== 'reducido'">
            <label for="clasesFocus">Clases Focus</label>
            <select
              id="clasesFocus"
              [ngModel]="nuevoUsuario().clasesFocus"
              (ngModelChange)="actualizarCampo('clasesFocus', +$event)"
            >
              <option *ngFor="let n of clasesOptions" [ngValue]="n">{{ n }}</option>
            </select>
          </div>

          <!-- Clases Reducido (visible si no es solo focus) -->
          <div class="form-group" *ngIf="nuevoUsuario().tipoGrupo !== 'focus'">
            <label for="clasesReducido">Clases Reducido</label>
            <select
              id="clasesReducido"
              [ngModel]="nuevoUsuario().clasesReducido"
              (ngModelChange)="actualizarCampo('clasesReducido', +$event)"
            >
              <option *ngFor="let n of clasesOptions" [ngValue]="n">{{ n }}</option>
            </select>
          </div>

          <!-- Tipo de cuota (solo para especial) -->
          <div class="form-group" *ngIf="nuevoUsuario().tipoGrupo === 'especial'">
            <label for="tipoCuota">Tipo de cuota</label>
            <select
              id="tipoCuota"
              [ngModel]="nuevoUsuario().tipoCuota"
              (ngModelChange)="actualizarCampo('tipoCuota', $event)"
            >
              <option value="semanal">Por semana</option>
              <option value="mensual">Por mes</option>
            </select>
          </div>

          <!-- Contraseña -->
          <div class="form-group form-group--full">
            <label for="password-field">Contraseña * (para enviar al usuario)</label>
            <div class="password-row">
              <input
                id="password-field"
                type="text"
                [value]="nuevoUsuario().password"
                readonly
                placeholder="Pulsa 'Generar' para crear una contraseña"
                class="password-input"
              />
              <button type="button" class="btn-generar" (click)="generarPassword()">
                <span class="material-symbols-rounded">autorenew</span>
                Generar
              </button>
              <button
                type="button"
                class="btn-copiar"
                (click)="copiarPassword()"
                [disabled]="!nuevoUsuario().password"
                [class.copiada]="passwordCopiada()"
                [attr.aria-label]="passwordCopiada() ? 'Copiada' : 'Copiar contraseña'"
              >
                <span class="material-symbols-rounded">
                  {{ passwordCopiada() ? 'check' : 'content_copy' }}
                </span>
              </button>
            </div>
            <span class="password-hint" *ngIf="nuevoUsuario().password">
              Copia esta contraseña y envíala al usuario por WhatsApp
            </span>
          </div>
        </div>

        <!-- Error -->
        <div class="mensaje-error" *ngIf="errorModal()" role="alert">
          <span class="material-symbols-rounded">error</span>
          {{ errorModal() }}
        </div>
      </ng-container>
    </div>

    <div class="modal-footer">
      <button class="btn-cancelar" (click)="cerrarModal()">
        {{ exitoModal() ? 'Cerrar' : 'Cancelar' }}
      </button>
      <button
        class="btn-guardar"
        (click)="guardarUsuario()"
        [disabled]="guardando() || !formularioValido() || !!exitoModal()"
        *ngIf="!exitoModal()"
      >
        <span class="material-symbols-rounded" *ngIf="!guardando()">save</span>
        <span class="spinner-small" *ngIf="guardando()"></span>
        {{ guardando() ? 'Guardando...' : 'Guardar Usuario' }}
      </button>
    </div>
  </div>
</div>
