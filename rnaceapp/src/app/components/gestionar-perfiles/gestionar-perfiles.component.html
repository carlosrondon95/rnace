<!-- src/app/components/gestionar-perfiles/gestionar-perfiles.component.html -->

<main class="perfiles-page">
  <!-- Header -->
  <header class="page-header">
    <button class="btn-volver" (click)="volver()">
      <span class="material-symbols-rounded">arrow_back</span>
      Volver
    </button>
    <h1>Gestionar Perfiles</h1>
  </header>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="search-box">
      <span class="material-symbols-rounded search-icon">search</span>
      <input
        type="text"
        placeholder="Buscar por nombre o teléfono..."
        [ngModel]="busqueda()"
        (ngModelChange)="busqueda.set($event)"
      />
    </div>
    <button class="btn-nuevo" (click)="abrirModalNuevo()">
      <span class="material-symbols-rounded">person_add</span>
      Nuevo Usuario
    </button>
  </div>

  <!-- Filtros -->
  <div class="filtros-bar">
    <div class="filtros-grupo">
      <div class="filtro-item">
        <label for="filtro-rol">Rol</label>
        <select
          id="filtro-rol"
          [ngModel]="filtros().rol"
          (ngModelChange)="actualizarFiltro('rol', $event)"
        >
          <option value="todos">Todos</option>
          <option value="cliente">Cliente</option>
          <option value="profesor">Profesor</option>
          <option value="admin">Admin</option>
        </select>
      </div>

      <div class="filtro-item">
        <label for="filtro-estado">Estado</label>
        <select
          id="filtro-estado"
          [ngModel]="filtros().activo"
          (ngModelChange)="actualizarFiltro('activo', $event)"
        >
          <option value="todos">Todos</option>
          <option value="activo">Activos</option>
          <option value="inactivo">Inactivos</option>
        </select>
      </div>

      <div class="filtro-item">
        <label for="filtro-tipo-grupo">Tipo de grupo</label>
        <select
          id="filtro-tipo-grupo"
          [ngModel]="filtros().tipoGrupo"
          (ngModelChange)="actualizarFiltro('tipoGrupo', $event)"
        >
          <option value="todos">Todos</option>
          <option value="focus">Focus</option>
          <option value="reducido">Reducido</option>
          <option value="hibrido">Híbrido</option>
          <option value="especial">Especial</option>
        </select>
      </div>
    </div>

    @if (hayFiltrosActivos()) {
      <button class="btn-limpiar" (click)="limpiarFiltros()">
        <span class="material-symbols-rounded">filter_alt_off</span>
        Limpiar
      </button>
    }
  </div>

  <!-- Loading -->
  @if (cargando()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Cargando perfiles...</p>
    </div>
  }

  <!-- Error -->
  @if (error() && !cargando()) {
    <div class="error-state">
      <span class="material-symbols-rounded">error</span>
      <p>{{ error() }}</p>
    </div>
  }

  <!-- Lista de perfiles -->
  @if (!cargando() && !error()) {
    <div class="perfiles-list">
      <div class="perfiles-count">
        {{ usuariosFiltrados().length }} usuario{{ usuariosFiltrados().length !== 1 ? 's' : '' }}
        @if (hayFiltrosActivos()) {
          <span class="filtros-activos">(filtrado)</span>
        }
      </div>

      @for (usuario of usuariosFiltrados(); track usuario.id) {
        <div class="perfil-card" [class.inactivo]="!usuario.activo">
          <div class="perfil-avatar">
            <span class="material-symbols-rounded">person</span>
          </div>

          <div class="perfil-info">
            <div class="perfil-nombre">
              {{ usuario.nombre || 'Sin nombre' }}
              @if (!usuario.activo) {
                <span class="badge-inactivo">Inactivo</span>
              }
            </div>
            <div class="perfil-telefono">
              <span class="material-symbols-rounded">phone</span>
              {{ usuario.telefono || 'Sin teléfono' }}
            </div>
          </div>

          <div class="perfil-meta">
            <span class="perfil-rol" [ngClass]="obtenerClaseRol(usuario.rol)">
              {{ usuario.rol }}
            </span>
            <span class="perfil-plan">
              {{ obtenerEtiquetaGrupo(usuario.plan) }}
            </span>
          </div>

          <div class="perfil-fecha">
            {{ formatearFecha(usuario.creado_en) }}
          </div>

          <div class="perfil-acciones">
            <button class="btn-editar" title="Editar perfil" (click)="abrirModalEditar(usuario)">
              <span class="material-symbols-rounded">edit</span>
            </button>
            <button
              class="btn-eliminar"
              title="Eliminar usuario"
              (click)="abrirModalEliminar(usuario)"
            >
              <span class="material-symbols-rounded">delete</span>
            </button>
          </div>
        </div>
      } @empty {
        <div class="no-resultados">
          <span class="material-symbols-rounded">person_off</span>
          @if (busqueda() || hayFiltrosActivos()) {
            <p>No se encontraron usuarios con los filtros aplicados</p>
          } @else {
            <p>No hay usuarios registrados</p>
          }
          @if (hayFiltrosActivos()) {
            <button class="btn-limpiar-inline" (click)="limpiarFiltros()">Limpiar filtros</button>
          }
        </div>
      }
    </div>
  }
</main>

<!-- Modal Crear/Editar Usuario -->
@if (mostrarModal()) {
  <div class="modal-overlay" role="dialog" aria-modal="true">
    <button class="modal-backdrop" (click)="cerrarModal()" aria-label="Cerrar modal">
      <span class="sr-only">Cerrar</span>
    </button>

    <div class="modal-content">
      <div class="modal-header">
        <h2>{{ modoEdicion() ? 'Editar Usuario' : 'Nuevo Usuario' }}</h2>
        <button class="btn-cerrar" (click)="cerrarModal()">
          <span class="material-symbols-rounded">close</span>
        </button>
      </div>

      <div class="modal-body">
        @if (exitoModal()) {
          <div class="mensaje-exito">
            <span class="material-symbols-rounded">check_circle</span>
            {{ exitoModal() }}
          </div>
        } @else {
          <div class="form-grid">
            <!-- Nombre -->
            <div class="form-group">
              <label for="nombre">Nombre *</label>
              <input
                id="nombre"
                type="text"
                [ngModel]="formulario().nombre"
                (ngModelChange)="actualizarCampo('nombre', $event)"
                placeholder="Juan"
              />
            </div>

            <!-- Apellidos -->
            <div class="form-group">
              <label for="apellidos">Apellidos</label>
              <input
                id="apellidos"
                type="text"
                [ngModel]="formulario().apellidos"
                (ngModelChange)="actualizarCampo('apellidos', $event)"
                placeholder="García López"
              />
            </div>

            <!-- Teléfono -->
            <div class="form-group">
              <label for="telefono">Teléfono * (usuario de acceso)</label>
              <input
                id="telefono"
                type="tel"
                [ngModel]="formulario().telefono"
                (ngModelChange)="actualizarCampo('telefono', $event)"
                placeholder="612345678"
                inputmode="numeric"
              />
            </div>

            <!-- Rol -->
            <div class="form-group">
              <label for="rol">Rol</label>
              <select
                id="rol"
                [ngModel]="formulario().rol"
                (ngModelChange)="actualizarCampo('rol', $event)"
              >
                @for (r of roles; track r.value) {
                  <option [value]="r.value">{{ r.label }}</option>
                }
              </select>
            </div>

            <!-- Estado activo (solo en edición) -->
            @if (modoEdicion()) {
              <div class="form-group form-group--full">
                <label class="checkbox-label">
                  <input
                    type="checkbox"
                    [checked]="formulario().activo"
                    (change)="actualizarCampo('activo', $any($event.target).checked)"
                  />
                  <span class="checkbox-text">Usuario activo</span>
                  <span class="checkbox-hint">Los usuarios inactivos no pueden iniciar sesión</span>
                </label>
              </div>
            }

            <!-- Separador Plan -->
            <div class="form-separator">
              <span>Plan de clases</span>
            </div>

            <!-- Tipo de grupo -->
            <div class="form-group form-group--full">
              <label for="tipoGrupo">Tipo de grupo *</label>
              <select
                id="tipoGrupo"
                [ngModel]="formulario().tipoGrupo"
                (ngModelChange)="actualizarCampo('tipoGrupo', $event)"
              >
                @for (tipo of tiposGrupo; track tipo.value) {
                  <option [value]="tipo.value">{{ tipo.label }}</option>
                }
              </select>
            </div>

            <!-- Campos para planes NORMALES (no especial) -->
            @if (formulario().tipoGrupo !== 'especial') {
              @if (formulario().tipoGrupo !== 'reducido') {
                <div class="form-group">
                  <label for="clasesFocus">Clases Focus / semana</label>
                  <select
                    id="clasesFocus"
                    [ngModel]="formulario().clasesFocus"
                    (ngModelChange)="actualizarCampo('clasesFocus', +$event)"
                  >
                    @for (n of clasesOptions; track n) {
                      <option [ngValue]="n">{{ n }}</option>
                    }
                  </select>
                </div>
              }

              @if (formulario().tipoGrupo !== 'focus') {
                <div class="form-group">
                  <label for="clasesReducido">Clases Reducido / semana</label>
                  <select
                    id="clasesReducido"
                    [ngModel]="formulario().clasesReducido"
                    (ngModelChange)="actualizarCampo('clasesReducido', +$event)"
                  >
                    @for (n of clasesOptions; track n) {
                      <option [ngValue]="n">{{ n }}</option>
                    }
                  </select>
                </div>
              }
            }

            <!-- Campos para plan ESPECIAL -->
            @if (formulario().tipoGrupo === 'especial') {
              <div class="form-group">
                <label for="sesionesFijasFocus">Sesiones Focus / mes</label>
                <select
                  id="sesionesFijasFocus"
                  [ngModel]="formulario().sesionesFijasFocus"
                  (ngModelChange)="actualizarCampo('sesionesFijasFocus', +$event)"
                >
                  @for (n of sesionesEspecialOptions; track n) {
                    <option [ngValue]="n">{{ n }}</option>
                  }
                </select>
              </div>

              <div class="form-group">
                <label for="sesionesFijasReducido">Sesiones Reducido / mes</label>
                <select
                  id="sesionesFijasReducido"
                  [ngModel]="formulario().sesionesFijasReducido"
                  (ngModelChange)="actualizarCampo('sesionesFijasReducido', +$event)"
                >
                  @for (n of sesionesEspecialOptions; track n) {
                    <option [ngValue]="n">{{ n }}</option>
                  }
                </select>
              </div>
            }

            <!-- Separador Contraseña -->
            <div class="form-separator">
              <span>{{ modoEdicion() ? 'Cambiar contraseña (opcional)' : 'Contraseña' }}</span>
            </div>

            <!-- Contraseña -->
            <div class="form-group form-group--full">
              <label for="password-field">
                {{ modoEdicion() ? 'Nueva contraseña' : 'Contraseña * (para enviar al usuario)' }}
              </label>
              <div class="password-row">
                <input
                  id="password-field"
                  type="text"
                  [value]="formulario().password"
                  readonly
                  [placeholder]="modoEdicion() ? 'Dejar vacío para no cambiar' : 'Pulsa Generar'"
                  class="password-input"
                />
                <button type="button" class="btn-generar" (click)="generarPassword()">
                  <span class="material-symbols-rounded">autorenew</span>
                  Generar
                </button>
                <button
                  type="button"
                  class="btn-copiar"
                  (click)="copiarPassword()"
                  [disabled]="!formulario().password"
                  [class.copiada]="passwordCopiada()"
                >
                  <span class="material-symbols-rounded">
                    {{ passwordCopiada() ? 'check' : 'content_copy' }}
                  </span>
                </button>
              </div>
              @if (formulario().password) {
                <span class="password-hint">
                  Copia esta contraseña y envíala al usuario por WhatsApp
                </span>
              }
            </div>
          </div>

          @if (errorModal()) {
            <div class="mensaje-error" role="alert">
              <span class="material-symbols-rounded">error</span>
              {{ errorModal() }}
            </div>
          }
        }
      </div>

      <div class="modal-footer">
        <button class="btn-cancelar" (click)="cerrarModal()">
          {{ exitoModal() ? 'Cerrar' : 'Cancelar' }}
        </button>
        @if (!exitoModal()) {
          <button
            class="btn-guardar"
            (click)="guardarUsuario()"
            [disabled]="guardando() || !formularioValido()"
          >
            @if (guardando()) {
              <span class="spinner-small"></span>
            } @else {
              <span class="material-symbols-rounded">save</span>
            }
            {{ guardando() ? 'Guardando...' : modoEdicion() ? 'Guardar Cambios' : 'Crear Usuario' }}
          </button>
        }
      </div>
    </div>
  </div>
}

<!-- Modal Eliminar Usuario -->
@if (mostrarModalEliminar()) {
  <div class="modal-overlay modal-overlay--danger" role="dialog" aria-modal="true">
    <button class="modal-backdrop" (click)="cerrarModalEliminar()" aria-label="Cerrar modal">
      <span class="sr-only">Cerrar</span>
    </button>

    <div class="modal-content modal-content--small">
      <div class="modal-header modal-header--danger">
        <h2>Eliminar Usuario</h2>
        <button class="btn-cerrar" (click)="cerrarModalEliminar()">
          <span class="material-symbols-rounded">close</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="eliminar-warning">
          <span class="material-symbols-rounded">warning</span>
          <p>
            ¿Estás seguro de eliminar a
            <strong>{{ usuarioAEliminar()?.nombre || 'este usuario' }}</strong
            >?
          </p>
          <p class="eliminar-hint">
            Esta acción eliminará todas sus reservas y datos. No se puede deshacer.
          </p>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancelar" (click)="cerrarModalEliminar()">Cancelar</button>
        <button
          class="btn-eliminar-confirmar"
          (click)="confirmarEliminar()"
          [disabled]="eliminando()"
        >
          @if (eliminando()) {
            <span class="spinner-small"></span>
          } @else {
            <span class="material-symbols-rounded">delete</span>
          }
          {{ eliminando() ? 'Eliminando...' : 'Sí, eliminar' }}
        </button>
      </div>
    </div>
  </div>
}
