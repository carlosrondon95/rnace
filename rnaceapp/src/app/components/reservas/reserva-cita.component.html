<!-- src/app/components/reservas/reserva-cita.component.html -->

<main class="reserva-page">
  <section class="reserva-card">
    <!-- Loading -->
    @if (cargando()) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Cargando disponibilidad...</p>
      </div>
    }

    <!-- Error general (mes cerrado, etc.) -->
    @if (!cargando() && error() && !mesAbierto()) {
      <div class="error-state">
        <span class="material-symbols-rounded error-icon">event_busy</span>
        <h2>Mes no disponible</h2>
        <p>{{ error() }}</p>
        <button class="btn-primary" (click)="volver()">Volver al inicio</button>
      </div>
    }

    <!-- Contenido principal -->
    @if (!cargando() && mesAbierto()) {
      <header class="reserva-header">
        <h1>Reservar cita</h1>
        <p class="lead">{{ nombreMes() | titlecase }}</p>
      </header>

      <!-- ========== INFO DE CUPOS SEGÚN TIPO DE PLAN ========== -->
      @if (infoCupos(); as info) {
        <div class="cupos-section">
          <!-- Plan FOCUS: Solo muestra focus -->
          @if (info.tipo === 'focus') {
            <div class="cupos-single">
              <div class="cupo-card cupo-focus">
                <div class="cupo-header">
                  <span class="cupo-icon material-symbols-rounded">fitness_center</span>
                  <span class="cupo-label">{{ info.titulo }}</span>
                </div>
                <div class="cupo-body">
                  <span class="cupo-value">{{ info.usadas }} / {{ info.total }}</span>
                  <span class="cupo-detail">usadas este mes</span>
                </div>
                @if (info.disponibles > 0) {
                  <div class="cupo-disponible">
                    {{ info.disponibles }} disponible{{ info.disponibles !== 1 ? 's' : '' }}
                  </div>
                }
                @if (info.recuperacion) {
                  <div class="cupo-recuperacion">
                    <span class="material-symbols-rounded">replay</span>
                    1 recuperación disponible
                  </div>
                }
              </div>
            </div>
          }

          <!-- Plan REDUCIDO: Solo muestra reducido -->
          @if (info.tipo === 'reducido') {
            <div class="cupos-single">
              <div class="cupo-card cupo-reducido">
                <div class="cupo-header">
                  <span class="cupo-icon material-symbols-rounded">groups</span>
                  <span class="cupo-label">{{ info.titulo }}</span>
                </div>
                <div class="cupo-body">
                  <span class="cupo-value">{{ info.usadas }} / {{ info.total }}</span>
                  <span class="cupo-detail">usadas este mes</span>
                </div>
                @if (info.disponibles > 0) {
                  <div class="cupo-disponible">
                    {{ info.disponibles }} disponible{{ info.disponibles !== 1 ? 's' : '' }}
                  </div>
                }
                @if (info.recuperacion) {
                  <div class="cupo-recuperacion">
                    <span class="material-symbols-rounded">replay</span>
                    1 recuperación disponible
                  </div>
                }
              </div>
            </div>
          }

          <!-- Plan HÍBRIDO: Muestra ambos -->
          @if (info.tipo === 'hibrido') {
            <div class="cupos-dual">
              <div class="cupo-card cupo-focus" [class.cupo-active]="modalidad() === 'focus'">
                <div class="cupo-header">
                  <span class="cupo-icon material-symbols-rounded">fitness_center</span>
                  <span class="cupo-label">Focus</span>
                </div>
                <div class="cupo-body">
                  <span class="cupo-value">{{ info.focus.usadas }} / {{ info.focus.total }}</span>
                  <span class="cupo-detail">usadas</span>
                </div>
                @if (info.focus.disponibles > 0) {
                  <div class="cupo-disponible">{{ info.focus.disponibles }} disp.</div>
                }
                @if (info.focus.recuperacion) {
                  <div class="cupo-recuperacion">
                    <span class="material-symbols-rounded">replay</span> 1 recup.
                  </div>
                }
              </div>

              <div class="cupo-card cupo-reducido" [class.cupo-active]="modalidad() === 'reducido'">
                <div class="cupo-header">
                  <span class="cupo-icon material-symbols-rounded">groups</span>
                  <span class="cupo-label">Reducido</span>
                </div>
                <div class="cupo-body">
                  <span class="cupo-value"
                    >{{ info.reducido.usadas }} / {{ info.reducido.total }}</span
                  >
                  <span class="cupo-detail">usadas</span>
                </div>
                @if (info.reducido.disponibles > 0) {
                  <div class="cupo-disponible">{{ info.reducido.disponibles }} disp.</div>
                }
                @if (info.reducido.recuperacion) {
                  <div class="cupo-recuperacion">
                    <span class="material-symbols-rounded">replay</span> 1 recup.
                  </div>
                }
              </div>
            </div>
          }

          <!-- Plan ESPECIAL: Muestra sesiones fijas al mes -->
          @if (info.tipo === 'especial') {
            <div class="cupos-especial">
              <div class="cupos-especial-header">
                <span class="material-symbols-rounded">star</span>
                <span>Plan Especial</span>
              </div>
              <div class="cupos-dual">
                @if (info.focus.total > 0) {
                  <div class="cupo-card cupo-focus" [class.cupo-active]="modalidad() === 'focus'">
                    <div class="cupo-header">
                      <span class="cupo-icon material-symbols-rounded">fitness_center</span>
                      <span class="cupo-label">Focus</span>
                    </div>
                    <div class="cupo-body">
                      <span class="cupo-value"
                        >{{ info.focus.usadas }} / {{ info.focus.total }}</span
                      >
                      <span class="cupo-detail">al mes</span>
                    </div>
                    @if (info.focus.disponibles > 0) {
                      <div class="cupo-disponible">{{ info.focus.disponibles }} disp.</div>
                    }
                  </div>
                }
                @if (info.reducido.total > 0) {
                  <div
                    class="cupo-card cupo-reducido"
                    [class.cupo-active]="modalidad() === 'reducido'"
                  >
                    <div class="cupo-header">
                      <span class="cupo-icon material-symbols-rounded">groups</span>
                      <span class="cupo-label">Reducido</span>
                    </div>
                    <div class="cupo-body">
                      <span class="cupo-value"
                        >{{ info.reducido.usadas }} / {{ info.reducido.total }}</span
                      >
                      <span class="cupo-detail">al mes</span>
                    </div>
                    @if (info.reducido.disponibles > 0) {
                      <div class="cupo-disponible">{{ info.reducido.disponibles }} disp.</div>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }

      <!-- ========== SELECTOR DE MODALIDAD (solo si puede elegir) ========== -->
      @if (puedeToggleModalidad()) {
        <div class="mode-toggle">
          @for (mod of modalidadesDisponibles(); track mod) {
            <button
              type="button"
              class="mode-btn"
              [class.mode-btn--active]="modalidad() === mod"
              [class.mode-btn--focus]="mod === 'focus'"
              [class.mode-btn--reducido]="mod === 'reducido'"
              (click)="selectModalidad(mod)"
            >
              <span class="mode-icon material-symbols-rounded">
                {{ mod === 'focus' ? 'fitness_center' : 'groups' }}
              </span>
              <div class="mode-content">
                <span class="mode-name">Grupo {{ getNombreModalidad(mod) }}</span>
                <span class="mode-subtitle">
                  {{ mod === 'focus' ? 'Máx. 3 personas' : 'Máx. 8 personas' }}
                </span>
              </div>
            </button>
          }
        </div>
      }

      <!-- Aviso sin cupo -->
      @if (!puedeReservar()) {
        <div class="aviso-cupo">
          <span class="material-symbols-rounded">info</span>
          <span
            >Has alcanzado tu límite de clases {{ getNombreModalidad(modalidad()) }} este mes.</span
          >
        </div>
      }

      <!-- ========== GRID DE SESIONES ========== -->
      @if (diasAgrupados().length > 0) {
        <div class="schedule-grid">
          @for (dia of diasAgrupados(); track dia.fecha) {
            <div class="day-card">
              <div class="day-header">
                <span class="day-name">{{ dia.diaNombre }}</span>
                <span class="day-date">{{ dia.fechaFormateada }}</span>
              </div>
              <div class="slots">
                @for (sesion of dia.sesiones; track sesion.id) {
                  <button
                    type="button"
                    class="slot-btn"
                    [class]="getEstadoClase(sesion)"
                    [disabled]="sesion.estado !== 'disponible'"
                    (click)="selectSesion(sesion)"
                  >
                    <span class="slot-hora">{{ sesion.hora }}</span>
                    <span class="slot-plazas">{{ getEstadoTexto(sesion) }}</span>
                  </button>
                }
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="no-sesiones">
          <span class="material-symbols-rounded">event_busy</span>
          <p>No hay sesiones de {{ getNombreModalidad(modalidad()) }} disponibles este mes.</p>
          <p class="no-sesiones-hint">Es posible que aún no se hayan generado los horarios.</p>
        </div>
      }

      <!-- ========== MENSAJES ========== -->
      @if (mensajeExito(); as msg) {
        <div class="mensaje-exito">
          <span class="material-symbols-rounded">check_circle</span>
          {{ msg }}
        </div>
      }

      @if (error() && mesAbierto()) {
        <div class="mensaje-error">
          <span class="material-symbols-rounded">error</span>
          {{ error() }}
        </div>
      }

      <!-- ========== PANEL DE CONFIRMACIÓN ========== -->
      @if (sesionSeleccionada(); as sesion) {
        <div class="confirm-panel">
          <div class="confirm-info">
            <p class="confirm-title">Has seleccionado:</p>
            <p class="confirm-detail">
              <strong>Grupo {{ getNombreModalidad(modalidad()) }}</strong>
              · {{ obtenerNombreDia(sesion.dia_semana) }} {{ formatearFecha(sesion.fecha) }} a las
              {{ sesion.hora }}
            </p>

            <!-- Opción de usar recuperación -->
            @if (
              cuposModalidadActual().tieneRecuperacion && cuposModalidadActual().disponibles === 0
            ) {
              <label class="recuperacion-check">
                <input
                  type="checkbox"
                  [checked]="usarRecuperacion()"
                  (change)="toggleRecuperacion()"
                />
                <span>Usar mi clase de recuperación</span>
              </label>
            }
          </div>

          <div class="confirm-actions">
            <!-- Si hay plazas y tiene cupo -->
            @if (
              sesion.estado === 'disponible' &&
              (cuposModalidadActual().disponibles > 0 || usarRecuperacion())
            ) {
              <button
                type="button"
                class="btn-confirm"
                [disabled]="guardando()"
                (click)="onConfirmar()"
              >
                @if (!guardando()) {
                  <span>Confirmar reserva</span>
                } @else {
                  <span>Reservando...</span>
                }
              </button>
            }

            <!-- Si no tiene cupo pero puede usar recuperación -->
            @if (
              sesion.estado === 'disponible' &&
              cuposModalidadActual().disponibles === 0 &&
              !usarRecuperacion() &&
              cuposModalidadActual().tieneRecuperacion
            ) {
              <button type="button" class="btn-confirm btn-secondary" disabled>
                Selecciona usar recuperación
              </button>
            }

            <!-- Si está completa, ofrecer lista de espera -->
            @if (sesion.estado === 'completa') {
              <button
                type="button"
                class="btn-lista-espera"
                [disabled]="guardando()"
                (click)="onListaEspera()"
              >
                @if (!guardando()) {
                  <span>Añadirme a lista de espera</span>
                } @else {
                  <span>Procesando...</span>
                }
              </button>
            }
          </div>
        </div>
      }

      <!-- ========== LEYENDA ========== -->
      <div class="leyenda">
        <div class="leyenda-item">
          <span class="leyenda-color leyenda-disponible"></span>
          <span>Disponible</span>
        </div>
        <div class="leyenda-item">
          <span class="leyenda-color leyenda-completa"></span>
          <span>Completa</span>
        </div>
        <div class="leyenda-item">
          <span class="leyenda-color leyenda-seleccionada"></span>
          <span>Seleccionada</span>
        </div>
      </div>
    }
  </section>
</main>
