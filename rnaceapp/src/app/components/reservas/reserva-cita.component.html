<!-- src/app/components/reservas/reserva-cita.component.html -->

<main class="reserva-page">
  <!-- Header con volver y navegación de mes -->
  <header class="page-header">
    <button class="btn-volver" (click)="volver()">
      <span class="material-symbols-rounded">arrow_back</span>
      Volver
    </button>
    <h1>{{ esAdmin() ? 'Ver Sesiones' : 'Reservar cita' }}</h1>
  </header>

  <!-- Navegación de meses -->
  <div class="mes-navegacion">
    <button class="btn-mes" (click)="mesAnterior()">
      <span class="material-symbols-rounded">chevron_left</span>
    </button>
    <span class="mes-nombre">{{ nombreMes() }}</span>
    <button class="btn-mes" (click)="mesSiguiente()">
      <span class="material-symbols-rounded">chevron_right</span>
    </button>
  </div>

  <!-- Badge mes cerrado -->
  @if (!mesAbierto() && !esAdmin()) {
    <div class="mes-cerrado-badge">
      <span class="material-symbols-rounded">lock</span>
      Mes cerrado para reservas
    </div>
  }

  <section class="reserva-card">
    <!-- Loading -->
    @if (cargando()) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Cargando disponibilidad...</p>
      </div>
    }

    <!-- Error (mes cerrado) -->
    @if (!cargando() && error() && !mesAbierto()) {
      <div class="error-state">
        <span class="material-symbols-rounded error-icon">event_busy</span>
        <h2>Mes no disponible</h2>
        <p>{{ error() }}</p>
      </div>
    }

    <!-- Contenido principal -->
    @if (!cargando() && (mesAbierto() || esAdmin())) {
      <!-- Info de cupos (solo clientes) -->
      @if (!esAdmin() && infoCupos(); as info) {
        <div class="cupos-section">
          @if (info.tipo === 'focus') {
            <div class="cupos-single">
              <div class="cupo-card cupo-focus">
                <div class="cupo-header">
                  <span class="cupo-icon material-symbols-rounded">fitness_center</span>
                  <span class="cupo-label">{{ info.titulo }}</span>
                </div>
                <div class="cupo-body">
                  <span class="cupo-value">{{ info.usadas }} / {{ info.total }}</span>
                  <span class="cupo-detail">usadas este mes</span>
                </div>
                @if (info.disponibles && info.disponibles > 0) {
                  <div class="cupo-disponible">
                    {{ info.disponibles }} disponible{{ info.disponibles !== 1 ? 's' : '' }}
                  </div>
                }
                @if (info.recuperacion) {
                  <div class="cupo-recuperacion">
                    <span class="material-symbols-rounded">replay</span>
                    1 recuperación disponible
                  </div>
                }
              </div>
            </div>
          }

          @if (info.tipo === 'reducido') {
            <div class="cupos-single">
              <div class="cupo-card cupo-reducido">
                <div class="cupo-header">
                  <span class="cupo-icon material-symbols-rounded">groups</span>
                  <span class="cupo-label">{{ info.titulo }}</span>
                </div>
                <div class="cupo-body">
                  <span class="cupo-value">{{ info.usadas }} / {{ info.total }}</span>
                  <span class="cupo-detail">usadas este mes</span>
                </div>
                @if (info.disponibles && info.disponibles > 0) {
                  <div class="cupo-disponible">
                    {{ info.disponibles }} disponible{{ info.disponibles !== 1 ? 's' : '' }}
                  </div>
                }
                @if (info.recuperacion) {
                  <div class="cupo-recuperacion">
                    <span class="material-symbols-rounded">replay</span>
                    1 recuperación disponible
                  </div>
                }
              </div>
            </div>
          }

          @if (info.tipo === 'hibrido' && info.focus && info.reducido) {
            <div class="cupos-dual">
              <div class="cupo-card cupo-focus" [class.cupo-active]="modalidad() === 'focus'">
                <div class="cupo-header">
                  <span class="cupo-icon material-symbols-rounded">fitness_center</span>
                  <span class="cupo-label">Focus</span>
                </div>
                <div class="cupo-body">
                  <span class="cupo-value">{{ info.focus.usadas }} / {{ info.focus.total }}</span>
                  <span class="cupo-detail">usadas</span>
                </div>
                @if (info.focus.disponibles > 0) {
                  <div class="cupo-disponible">{{ info.focus.disponibles }} disp.</div>
                }
                @if (info.focus.recuperacion) {
                  <div class="cupo-recuperacion">
                    <span class="material-symbols-rounded">replay</span> 1 recup.
                  </div>
                }
              </div>

              <div class="cupo-card cupo-reducido" [class.cupo-active]="modalidad() === 'reducido'">
                <div class="cupo-header">
                  <span class="cupo-icon material-symbols-rounded">groups</span>
                  <span class="cupo-label">Reducido</span>
                </div>
                <div class="cupo-body">
                  <span class="cupo-value"
                    >{{ info.reducido.usadas }} / {{ info.reducido.total }}</span
                  >
                  <span class="cupo-detail">usadas</span>
                </div>
                @if (info.reducido.disponibles > 0) {
                  <div class="cupo-disponible">{{ info.reducido.disponibles }} disp.</div>
                }
                @if (info.reducido.recuperacion) {
                  <div class="cupo-recuperacion">
                    <span class="material-symbols-rounded">replay</span> 1 recup.
                  </div>
                }
              </div>
            </div>
          }

          @if (info.tipo === 'especial' && info.focus && info.reducido) {
            <div class="cupos-especial">
              <div class="cupos-especial-header">
                <span class="material-symbols-rounded">star</span>
                <span>Plan Especial</span>
              </div>
              <div class="cupos-dual">
                @if (info.focus.total > 0) {
                  <div class="cupo-card cupo-focus" [class.cupo-active]="modalidad() === 'focus'">
                    <div class="cupo-header">
                      <span class="cupo-icon material-symbols-rounded">fitness_center</span>
                      <span class="cupo-label">Focus</span>
                    </div>
                    <div class="cupo-body">
                      <span class="cupo-value"
                        >{{ info.focus.usadas }} / {{ info.focus.total }}</span
                      >
                      <span class="cupo-detail">al mes</span>
                    </div>
                    @if (info.focus.disponibles > 0) {
                      <div class="cupo-disponible">{{ info.focus.disponibles }} disp.</div>
                    }
                  </div>
                }
                @if (info.reducido.total > 0) {
                  <div
                    class="cupo-card cupo-reducido"
                    [class.cupo-active]="modalidad() === 'reducido'"
                  >
                    <div class="cupo-header">
                      <span class="cupo-icon material-symbols-rounded">groups</span>
                      <span class="cupo-label">Reducido</span>
                    </div>
                    <div class="cupo-body">
                      <span class="cupo-value"
                        >{{ info.reducido.usadas }} / {{ info.reducido.total }}</span
                      >
                      <span class="cupo-detail">al mes</span>
                    </div>
                    @if (info.reducido.disponibles > 0) {
                      <div class="cupo-disponible">{{ info.reducido.disponibles }} disp.</div>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }

      <!-- Selector de modalidad -->
      @if (puedeToggleModalidad()) {
        <div class="mode-toggle">
          @for (mod of modalidadesDisponibles(); track mod) {
            <button
              type="button"
              class="mode-btn"
              [class.mode-btn--active]="modalidad() === mod"
              [class.mode-btn--focus]="mod === 'focus'"
              [class.mode-btn--reducido]="mod === 'reducido'"
              (click)="selectModalidad(mod)"
            >
              <span class="mode-icon material-symbols-rounded">
                {{ mod === 'focus' ? 'fitness_center' : 'groups' }}
              </span>
              <div class="mode-content">
                <span class="mode-name">Grupo {{ getNombreModalidad(mod) }}</span>
                <span class="mode-subtitle">
                  {{ mod === 'focus' ? 'Máx. 3 personas' : 'Máx. 8 personas' }}
                </span>
              </div>
            </button>
          }
        </div>
      }

      <!-- Aviso admin -->
      @if (esAdmin()) {
        <div class="aviso-admin">
          <span class="material-symbols-rounded">info</span>
          <span>Estás viendo las sesiones como administrador. No puedes reservar.</span>
        </div>
      }

      <!-- Aviso sin cupo -->
      @if (!esAdmin() && !puedeReservar()) {
        <div class="aviso-cupo">
          <span class="material-symbols-rounded">info</span>
          <span
            >Has alcanzado tu límite de clases {{ getNombreModalidad(modalidad()) }} este mes.</span
          >
        </div>
      }

      <!-- Grid de sesiones por semanas -->
      @if (semanasAgrupadas().length > 0) {
        <div class="semanas-container">
          @for (semana of semanasAgrupadas(); track semana.numeroSemana) {
            <div class="semana-card">
              <div class="semana-header">
                <span class="semana-label">{{ semana.tituloSemana }}</span>
              </div>

              <div class="semana-grid">
                @for (dia of semana.dias; track dia.fecha) {
                  <div
                    class="dia-col"
                    [class.dia-col--fin-semana]="dia.esFinSemana"
                    [class.dia-col--festivo]="dia.esFestivo"
                  >
                    <div class="dia-header">
                      <span class="dia-nombre">{{ dia.diaNombre }}</span>
                      <span class="dia-fecha">{{ dia.fechaFormateada }}</span>
                    </div>

                    <!-- Mostrar badge si es festivo o fin de semana -->
                    @if (dia.esFestivo) {
                      <div class="dia-bloqueado">
                        <span class="material-symbols-rounded">block</span>
                        <span>Festivo</span>
                      </div>
                    } @else if (dia.esFinSemana) {
                      <div class="dia-bloqueado">
                        <span class="material-symbols-rounded">event_busy</span>
                        <span>Cerrado</span>
                      </div>
                    } @else if (dia.sesiones.length === 0) {
                      <div class="dia-vacio">
                        <span>Sin sesiones</span>
                      </div>
                    }

                    <!-- Slots de sesiones -->
                    @if (dia.sesiones.length > 0 && !dia.esFestivo && !dia.esFinSemana) {
                      <div class="dia-slots">
                        @for (sesion of dia.sesiones; track sesion.id) {
                          <button
                            type="button"
                            class="slot-btn"
                            [class]="getEstadoClase(sesion)"
                            [disabled]="
                              sesion.estado === 'pasada' ||
                              sesion.estado === 'bloqueada' ||
                              esAdmin()
                            "
                            (click)="selectSesion(sesion)"
                          >
                            <span class="slot-hora">{{ sesion.hora }}</span>
                            <span class="slot-plazas">{{ getEstadoTexto(sesion) }}</span>
                          </button>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="no-sesiones">
          <span class="material-symbols-rounded">event_busy</span>
          <p>No hay sesiones de {{ getNombreModalidad(modalidad()) }} disponibles este mes.</p>
          <p class="no-sesiones-hint">Es posible que aún no se hayan generado los horarios.</p>
        </div>
      }

      <!-- Mensajes -->
      @if (mensajeExito(); as msg) {
        <div class="mensaje-exito">
          <span class="material-symbols-rounded">check_circle</span>
          {{ msg }}
        </div>
      }

      @if (error() && mesAbierto()) {
        <div class="mensaje-error">
          <span class="material-symbols-rounded">error</span>
          {{ error() }}
        </div>
      }

      <!-- Leyenda -->
      <div class="leyenda">
        <div class="leyenda-item">
          <span class="leyenda-color leyenda-disponible"></span>
          <span>Disponible</span>
        </div>
        <div class="leyenda-item">
          <span class="leyenda-color leyenda-completa"></span>
          <span>Completa</span>
        </div>
        <div class="leyenda-item">
          <span class="leyenda-color leyenda-bloqueada"></span>
          <span>Cerrada</span>
        </div>
        <div class="leyenda-item">
          <span class="leyenda-color leyenda-seleccionada"></span>
          <span>Seleccionada</span>
        </div>
      </div>
    }
  </section>

  <!-- Panel de confirmación (solo clientes) -->
  @if (!esAdmin() && sesionSeleccionada(); as sesion) {
    <div class="confirm-panel">
      <div class="confirm-info">
        <p class="confirm-title">Has seleccionado:</p>
        <p class="confirm-detail">
          <strong>Grupo {{ getNombreModalidad(modalidad()) }}</strong>
          · {{ obtenerNombreDia(sesion.dia_semana) }} {{ formatearFecha(sesion.fecha) }} a las
          {{ sesion.hora }}
        </p>

        @if (cuposModalidadActual().tieneRecuperacion && cuposModalidadActual().disponibles === 0) {
          <label class="recuperacion-check">
            <input type="checkbox" [checked]="usarRecuperacion()" (change)="toggleRecuperacion()" />
            <span>Usar mi clase de recuperación</span>
          </label>
        }
      </div>

      <div class="confirm-actions">
        @if (
          sesion.estado === 'disponible' &&
          (cuposModalidadActual().disponibles > 0 || usarRecuperacion())
        ) {
          <button
            type="button"
            class="btn-confirm"
            [disabled]="guardando()"
            (click)="onConfirmar()"
          >
            {{ guardando() ? 'Reservando...' : 'Confirmar reserva' }}
          </button>
        }

        @if (
          sesion.estado === 'disponible' &&
          cuposModalidadActual().disponibles === 0 &&
          !usarRecuperacion() &&
          cuposModalidadActual().tieneRecuperacion
        ) {
          <button type="button" class="btn-confirm btn-secondary" disabled>
            Selecciona usar recuperación
          </button>
        }

        @if (sesion.estado === 'completa') {
          <button
            type="button"
            class="btn-lista-espera"
            [disabled]="guardando()"
            (click)="onListaEspera()"
          >
            {{ guardando() ? 'Procesando...' : 'Añadirme a lista de espera' }}
          </button>
        }
      </div>
    </div>
  }
</main>
