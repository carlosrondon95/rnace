<!-- src/app/components/reservas/reserva-cita.component.html -->
<!-- NUEVO SISTEMA: Recuperar clases y lista de espera -->

<main class="page-container">
  <!-- Header -->
  <header class="page-header">
    <button class="btn-volver" (click)="volver()">
      <span class="material-symbols-rounded">arrow_back</span>
      Volver
    </button>
    <h1>Recuperar clase</h1>
  </header>

  <!-- Navegación de meses -->
  <div class="mes-navegacion">
    <button class="btn-mes" (click)="mesAnterior()" aria-label="Mes anterior">
      <span class="material-symbols-rounded">chevron_left</span>
    </button>
    <span class="mes-nombre">{{ nombreMes() }}</span>
    <button class="btn-mes" (click)="mesSiguiente()" aria-label="Mes siguiente">
      <span class="material-symbols-rounded">chevron_right</span>
    </button>
  </div>

  <!-- Badge mes cerrado -->
  @if (!mesAbierto() && !cargando()) {
  <div class="mes-cerrado-badge" role="alert">
    <span class="material-symbols-rounded">lock</span>
    Este mes aún no está abierto
  </div>
  }

  <section class="reserva-card">
    <!-- Loading -->
    @if (cargando()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Cargando disponibilidad...</p>
    </div>
    }

    <!-- Contenido principal -->
    @if (!cargando() && mesAbierto()) {
    <!-- Info de recuperaciones -->
    <div class="recuperaciones-section">
      <div class="recuperaciones-header">
        <span class="material-symbols-rounded">replay</span>
        <span>Tus recuperaciones disponibles</span>
      </div>

      @if (recuperaciones().length === 0) {
      <div class="sin-recuperaciones">
        <p>No tienes recuperaciones pendientes.</p>
        <p class="hint">Las recuperaciones se generan cuando cancelas una clase con más de 1 hora de antelación.</p>
      </div>
      } @else {
      <div class="recuperaciones-lista">
        @for (recup of recuperaciones(); track recup.id) {
        <div class="recuperacion-card" [class.recup-focus]="recup.modalidad === 'focus'"
          [class.recup-reducido]="recup.modalidad === 'reducido'" [class.invalida]="!esValidaParaMesActual(recup)">
          <div class="recup-modalidad">
            <span class="material-symbols-rounded">
              {{ recup.modalidad === 'focus' ? 'fitness_center' : 'groups' }}
            </span>
            {{ recup.modalidad === 'focus' ? 'Focus' : 'Reducido' }}
          </div>
            <div class="recup-validez">
            <span [class.texto-invalida]="!esValidaParaMesActual(recup) && !esFuturaParaMesActual(recup)"
                  [class.texto-futura]="esFuturaParaMesActual(recup)">
              {{ getTextoValidez(recup) }}
            </span>
          </div>
          @if (recup.motivo === 'festivo') {
          <span class="recup-origen">Por festivo</span>
          }
        </div>
        }
      </div>
      }
    </div>

    <!-- Selector de modalidad -->
    @if (puedeToggleModalidad()) {
    <div class="mode-toggle" role="radiogroup" aria-label="Seleccionar modalidad">
      @for (mod of modalidadesDisponibles(); track mod) {
      <button type="button" class="mode-btn" [class.mode-btn--active]="modalidad() === mod"
        [class.mode-btn--focus]="mod === 'focus'" [class.mode-btn--reducido]="mod === 'reducido'"
        [attr.aria-pressed]="modalidad() === mod" (click)="selectModalidad(mod)">
        <span class="mode-icon material-symbols-rounded">
          {{ mod === 'focus' ? 'fitness_center' : 'groups' }}
        </span>
        <div class="mode-content">
          <span class="mode-name">Grupo {{ getNombreModalidad(mod) }}</span>
          <span class="mode-subtitle">
            {{ mod === 'focus' ? 'Máx. 3 personas' : 'Máx. 8 personas' }}
          </span>
        </div>
      </button>
      }
    </div>
    }

    <!-- Aviso si no tiene recuperaciones de esta modalidad -->
    @if (!tieneRecuperacion()) {
    <div class="aviso-sin-recup" role="alert">
      <span class="material-symbols-rounded">info</span>
      <span>No tienes recuperaciones de {{ getNombreModalidad(modalidad()) }}. Puedes apuntarte a lista de
        espera.</span>
    </div>
    }

    <!-- Grid de sesiones por semanas -->
    @if (semanasAgrupadas().length > 0) {
    <div class="semanas-container">
      @for (semana of semanasAgrupadas(); track semana.numeroSemana) {
      <div class="semana-card">
        <div class="semana-header">
          <span class="semana-label">{{ semana.tituloSemana }}</span>
        </div>

        <div class="semana-grid">
          @for (dia of semana.dias; track dia.fecha) {
          <div class="dia-col">
            <div class="dia-header">
              <span class="dia-nombre">{{ dia.diaNombre }}</span>
              <span class="dia-fecha">{{ dia.fechaFormateada }}</span>
            </div>

            @if (dia.sesiones.length === 0) {
            <div class="dia-vacio">
              <span>Sin sesiones</span>
            </div>
            } @else {
            <div class="dia-slots">
              @for (sesion of dia.sesiones; track sesion.id) {
              <button type="button" class="slot-btn" [class]="getEstadoClase(sesion)"
                [disabled]="sesion.estado === 'pasada'" (click)="selectSesion(sesion)"
                [attr.aria-label]="dia.diaNombre + ' ' + sesion.hora + ' - ' + getEstadoTexto(sesion)">
                <span class="slot-hora">{{ sesion.hora }}</span>
                <span class="slot-plazas">{{ getEstadoTexto(sesion) }}</span>
              </button>
              }
            </div>
            }
          </div>
          }
        </div>
      </div>
      }
    </div>
    } @else {
    <div class="no-sesiones">
      <span class="material-symbols-rounded">event_busy</span>
      <p>No hay sesiones de {{ getNombreModalidad(modalidad()) }} disponibles este mes.</p>
    </div>
    }

    <!-- Mensajes -->
    @if (mensajeExito(); as msg) {
    <div class="mensaje-exito" role="status">
      <span class="material-symbols-rounded">check_circle</span>
      {{ msg }}
    </div>
    }

    @if (error(); as err) {
    <div class="mensaje-error" role="alert">
      <span class="material-symbols-rounded">error</span>
      {{ err }}
    </div>
    }

    <!-- Leyenda -->
    <div class="leyenda">
      <div class="leyenda-item">
        <span class="leyenda-color leyenda-disponible"></span>
        <span>Con plazas</span>
      </div>
      <div class="leyenda-item">
        <span class="leyenda-color leyenda-completa"></span>
        <span>Completa</span>
      </div>
      <div class="leyenda-item">
        <span class="leyenda-color leyenda-lista-espera"></span>
        <span>En lista de espera</span>
      </div>
      <div class="leyenda-item">
        <span class="leyenda-color leyenda-seleccionada"></span>
        <span>Seleccionada</span>
      </div>
    </div>
    }
  </section>

  <!-- Modal de confirmación -->
  @if (sesionSeleccionada(); as sesion) {
  <div class="modal-overlay" (click)="cerrarModal($event)">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <!-- Header del modal -->
      <div class="modal-header">
        <h2 id="modal-title">Confirmar selección</h2>
        <button type="button" class="btn-cerrar-modal" (click)="deseleccionarSesion()" aria-label="Cerrar">
          <span class="material-symbols-rounded">close</span>
        </button>
      </div>

      <!-- Contenido del modal -->
      <div class="modal-body">
        <div class="sesion-seleccionada">
          <div class="sesion-icono" [class.icono-focus]="modalidad() === 'focus'"
            [class.icono-reducido]="modalidad() === 'reducido'">
            <span class="material-symbols-rounded">
              {{ modalidad() === 'focus' ? 'fitness_center' : 'groups' }}
            </span>
          </div>
          <div class="sesion-detalles">
            <span class="sesion-modalidad">Grupo {{ getNombreModalidad(modalidad()) }}</span>
            <span class="sesion-fecha">{{ obtenerNombreDia(sesion.fecha) | titlecase }} {{ formatearFecha(sesion.fecha)
              }}</span>
            <span class="sesion-hora">{{ sesion.hora }}</span>
          </div>
        </div>

        <div class="sesion-estado">
          @if (sesion.estado === 'disponible') {
          <span class="estado-badge estado-disponible">
            <span class="material-symbols-rounded">check_circle</span>
            {{ sesion.plazas_disponibles }} plaza{{ sesion.plazas_disponibles !== 1 ? 's' : '' }} disponible{{
            sesion.plazas_disponibles !== 1 ? 's' : '' }}
          </span>
          } @else {
          <span class="estado-badge estado-completa">
            <span class="material-symbols-rounded">group</span>
            Sesión completa
          </span>
          }
        </div>
      </div>

      <!-- Acciones del modal -->
      <div class="modal-actions">
        <!-- Si hay plazas y tiene recuperación -->
        @if (sesion.estado === 'disponible' && tieneRecuperacionValidaMes()) {
        <button type="button" class="btn-accion btn-primario" [disabled]="guardando()" (click)="usarRecuperacion()">
          @if (guardando()) {
          <span class="spinner-small"></span>
          Procesando...
          } @else {
          <span class="material-symbols-rounded">replay</span>
          Usar recuperación
          }
        </button>
        }

        <!-- Si hay plazas pero NO tiene recuperación VÁLIDA -->
        @if (sesion.estado === 'disponible' && !tieneRecuperacionValidaMes()) {
        <button type="button" class="btn-accion btn-deshabilitado" disabled>
          <span class="material-symbols-rounded">block</span>
          @if (tieneRecuperacion()) {
          Recuperación no válida para este mes
          } @else {
          Sin recuperaciones disponibles
          }
        </button>
        }

        <!-- Si está completa, botón de lista de espera -->
        @if (sesion.estado === 'completa') {
        <button type="button"
          [class]="sesion.en_lista_espera ? 'btn-accion btn-quitar-espera' : 'btn-accion btn-espera'"
          [disabled]="guardando()" (click)="toggleListaEspera(sesion)">
          @if (guardando()) {
          <span class="spinner-small"></span>
          Procesando...
          } @else if (sesion.en_lista_espera) {
          <span class="material-symbols-rounded">remove_circle</span>
          Quitar de lista de espera
          } @else {
          <span class="material-symbols-rounded">notification_add</span>
          Apuntarme a lista de espera
          }
        </button>
        }

        <button type="button" class="btn-accion btn-cancelar" (click)="deseleccionarSesion()">
          Cancelar
        </button>
      </div>
    </div>
  </div>
  }
</main>