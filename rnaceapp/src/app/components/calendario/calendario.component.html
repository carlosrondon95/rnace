<!-- src/app/components/calendario/calendario.component.html -->

<main class="page-container">
  <!-- Header con botón volver -->
  @if (!cargando()) {
  <header class="page-header">
    <button class="btn-volver" (click)="volver()">
      <span class="material-symbols-rounded">arrow_back</span>
      Volver
    </button>
    <h1>{{ esAdmin() ? 'Gestionar Calendario' : 'Mis Clases' }}</h1>
  </header>
  }

  <!-- Loading -->
  @if (cargando()) {
  <div class="loading-state">
    <div class="spinner"></div>
    <p>Cargando calendario...</p>
  </div>
  }

  <!-- Contenido principal -->
  @if (!cargando()) {
  <!-- Vista Calendario (para TODOS: Admin y Cliente) -->
  <div class="calendario-container">
    <!-- Navegación del mes -->
    <div class="mes-navegacion">
      <button class="btn-nav" (click)="mesAnterior()" [disabled]="guardando()">
        <span class="material-symbols-rounded">chevron_left</span>
      </button>

      <div class="mes-info">
        <h2>{{ nombreMes() | titlecase }}</h2>
        <span class="mes-estado" [class.mes-abierto]="mesEstaAbierto()">
          {{ mesEstaAbierto() ? 'Mes abierto' : 'Mes cerrado' }}
        </span>
      </div>

      <button class="btn-nav" (click)="mesSiguiente()" [disabled]="guardando()">
        <span class="material-symbols-rounded">chevron_right</span>
      </button>
    </div>

    <!-- Panel de control (solo admin) -->
    @if (esAdmin()) {
    <div class="panel-admin">
      <!-- Botones de acción arriba -->
      @if (!modoEdicion()) {
      <div class="admin-actions">
        @if (!mesEstaAbierto()) {
        <button class="btn-admin btn-admin--primary" (click)="activarModoEdicion()" [disabled]="guardando()">
          <span class="material-symbols-rounded">edit_calendar</span>
          Configurar y abrir mes
        </button>
        }

        @if (mesEstaAbierto()) {
        <button class="btn-admin btn-admin--secondary" (click)="activarModoEdicion()" [disabled]="guardando()">
          <span class="material-symbols-rounded">edit_calendar</span>
          Editar días festivos
        </button>

        <button class="btn-admin btn-admin--danger" (click)="cerrarMes()" [disabled]="guardando()">
          <span class="material-symbols-rounded">lock</span>
          Cerrar mes
        </button>
        }
      </div>

      <!-- Estadísticas debajo de los botones -->
      <div class="estadisticas">
        <div class="stat-card">
          <span class="stat-label">Total reservas</span>
          <span class="stat-value">{{ totalReservas() }}</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Focus</span>
          <span class="stat-value stat-focus">{{ reservasPorModalidad().focus }}</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Reducido</span>
          <span class="stat-value stat-reducido">{{
            reservasPorModalidad().reducido
            }}</span>
        </div>
      </div>
      }

      <!-- Modo edición -->
      @if (modoEdicion()) {
      <div class="edicion-panel">
        <div class="edicion-info">
          <span class="material-symbols-rounded">info</span>
          <div class="edicion-texto">
            <strong>Modo configuración</strong>
            <p>
              Haz clic en los días laborables (lun-vie) para marcarlos como
              festivos/cerrados
            </p>
          </div>
        </div>

        <div class="edicion-resumen">
          <span class="festivos-count">
            {{ festivosSeleccionados().size }} día{{
            festivosSeleccionados().size !== 1 ? 's' : ''
            }}
            festivo{{ festivosSeleccionados().size !== 1 ? 's' : '' }}
          </span>
        </div>

        <div class="edicion-actions">
          <button class="btn-edicion btn-cancelar" (click)="cancelarEdicion()" [disabled]="guardando()">
            Cancelar
          </button>
          <button class="btn-edicion btn-guardar" (click)="guardarYAbrirMes()" [disabled]="guardando()">
            @if (!guardando()) {
            <span class="material-symbols-rounded">save</span>
            } @else {
            <span class="spinner-small"></span>
            }
            {{
            guardando()
            ? 'Guardando...'
            : mesEstaAbierto()
            ? 'Guardar cambios'
            : 'Guardar y abrir mes'
            }}
          </button>
        </div>
      </div>
      }
    </div>
    }

    <!-- Mensajes -->
    @if (mensajeExito()) {
    <div class="mensaje-exito">
      <span class="material-symbols-rounded">check_circle</span>
      {{ mensajeExito() }}
      <button class="btn-cerrar-mensaje" (click)="mensajeExito.set(null)" aria-label="Cerrar">
        <span class="material-symbols-rounded">close</span>
      </button>
    </div>
    }

    @if (error()) {
    <div class="mensaje-error">
      <span class="material-symbols-rounded">error</span>
      {{ error() }}
    </div>
    }

    <!-- Calendario -->
    <div class="calendario-grid">
      <!-- Cabecera días de la semana -->
      @for (dia of diasSemana; track dia) {
      <div class="dia-header">{{ dia }}</div>
      }

      <!-- Celdas de días (solo L-V) -->
      @for (dia of diasCalendarioLaborables(); track dia.fecha) {
      <button type="button" [class]="getDiaClases(dia)"
        [class.clickable]="(modoEdicion() && dia.esDelMes && dia.esLaborable) || (!modoEdicion() && dia.reservas.length > 0)"
        [disabled]="!((modoEdicion() && dia.esDelMes && dia.esLaborable) || (!modoEdicion() && dia.reservas.length > 0))"
        [attr.aria-label]="'Día ' + dia.dia + (dia.esFestivo ? ' - Festivo' : '')" (click)="onClickDia(dia)">
        <!-- Número del día -->
        <div class="dia-numero">
          {{ dia.dia }}
        </div>

        <!-- Indicador de festivo (modo edición) -->
        @if (modoEdicion() && esFestivoSeleccionado(dia.fecha)) {
        <div class="festivo-badge">
          <span class="material-symbols-rounded">block</span>
          Festivo
        </div>
        }

        <!-- Indicador de festivo (modo normal) -->
        @if (!modoEdicion() && dia.esFestivo && dia.esDelMes) {
        <div class="festivo-badge">
          <span class="material-symbols-rounded">event_busy</span>
          Festivo
        </div>
        }

        <!-- Indicadores de reservas (Solo admin, vista general) -->
        @if (dia.reservas.length > 0 && !modoEdicion()) {
        <div class="dia-indicadores">
          @if (getReservasCount(dia, 'focus') > 0) {
          <span class="indicador indicador-focus">F: {{ getReservasCount(dia, 'focus') }}</span>
          }
          @if (getReservasCount(dia, 'reducido') > 0) {
          <span class="indicador indicador-reducido">R: {{ getReservasCount(dia, 'reducido') }}</span>
          }
        </div>
        }
      </button>
      }
    </div>

    <!-- Leyenda -->
    <div class="leyenda">
      <div class="leyenda-item">
        <span class="leyenda-color leyenda-hoy"></span>
        <span>Hoy</span>
      </div>
      @if (!modoEdicion()) {
      <div class="leyenda-item">
        <span class="leyenda-color leyenda-festivo"></span>
        <span>Festivo</span>
      </div>
      }
      @if (!esAdmin()) {
      <div class="leyenda-item">
        <span class="leyenda-color leyenda-reserva-propia"></span>
        <span>Tus clases</span>
      </div>
      }
      @if (esAdmin()) {
      <div class="leyenda-item">
        <span class="leyenda-color leyenda-focus"></span>
        <span>Focus</span>
      </div>
      <div class="leyenda-item">
        <span class="leyenda-color leyenda-reducido"></span>
        <span>Reducido</span>
      </div>
      }
    </div>

    <!-- Modal Detalle Día -->
    @if (diaSeleccionado()) {
    <div class="modal-overlay" (click)="cerrarDetalleDia()">
      <div class="modal-detalle-dia" (click)="$event.stopPropagation()">
        <header class="modal-header">
          <button class="btn-cerrar" (click)="cerrarDetalleDia()" aria-label="Cerrar">
            <span class="material-symbols-rounded">close</span>
          </button>
          <h3>
            {{ esAdmin() ? 'Reservas del día' : 'Tu clase del día' }} {{ diaSeleccionado()!.dia }}
            @if (!esAdmin() && tipoGrupoUsuario()) {
            <span style="font-size: 0.8rem; font-weight: normal; opacity: 0.7;">
              ({{ tipoGrupoUsuario() | titlecase }})
            </span>
            }
          </h3>
        </header>

        <div class="modal-content">
          @if (cargando()) {
          <div class="loading-state">
            <span class="spinner-small"></span>
            <p>Cargando disponibilidad...</p>
          </div>
          } @else {
          @if (esAdmin()) {
          @if (pasoModalDetalle() === 'tipo') {
          <!-- PASO 1: Selección de Tipo de Grupo -->
          <div class="seleccion-grupo-container">
            <button class="btn-tipo-grupo btn-focus" (click)="seleccionarTipoGrupo('focus')">
              <div class="tipo-header">
                <span class="material-symbols-rounded">fitness_center</span>
                <h4>Grupo Focus</h4>
              </div>
              <div class="tipo-stats">
                <span class="count">{{ getReservasCount(diaSeleccionado()!, 'focus') }}</span>
                <span class="label">reservas</span>
              </div>
              <span class="material-symbols-rounded arrow-icon">arrow_forward</span>
            </button>

            <button class="btn-tipo-grupo btn-reducido" (click)="seleccionarTipoGrupo('reducido')">
              <div class="tipo-header">
                <span class="material-symbols-rounded">groups</span>
                <h4>Grupo Reducido</h4>
              </div>
              <div class="tipo-stats">
                <span class="count">{{ getReservasCount(diaSeleccionado()!, 'reducido') }}</span>
                <span class="label">reservas</span>
              </div>
              <span class="material-symbols-rounded arrow-icon">arrow_forward</span>
            </button>
          </div>
          } @else {
          <!-- PASO 2: Lista de reservas filtradas -->
          <div class="lista-header-nav">
            <button class="btn-volver-modal" (click)="volverASeleccionTipo()">
              <span class="material-symbols-rounded">arrow_back</span>
              Volver a grupos
            </button>
            <span class="filtro-actual bubble" [class.bubble-focus]="tipoGrupoSeleccionado() === 'focus'"
              [class.bubble-reducido]="tipoGrupoSeleccionado() === 'reducido'">
              {{ tipoGrupoSeleccionado() | titlecase }}
            </span>
          </div>

          @if (reservasAgrupadasPorHora().length > 0) {
          <div class="lista-reservas-detalle animate-fade-in">
            @for (grupo of reservasAgrupadasPorHora(); track grupo.hora) {
            <div class="hora-group">
              <div class="hora-header">
                <span class="material-symbols-rounded">schedule</span>
                {{ grupo.hora }}
              </div>

              <div class="reservas-hora-list">
                @for (reserva of grupo.reservas; track reserva.id) {
                <div class="reserva-detalle-card" [class.reserva-focus]="reserva.modalidad === 'focus'"
                  [class.reserva-reducido]="reserva.modalidad === 'reducido'">

                  <div class="reserva-contenido">
                    <!-- Hora eliminada de aquí porque está en el header -->

                    <div class="reserva-usuario-info">
                      <span class="usuario-nombre">{{ reserva.usuario_nombre }}</span>
                      @if (reserva.usuario_telefono) {
                      <span class="usuario-telefono">{{ reserva.usuario_telefono }}</span>
                      }
                    </div>

                    <div class="reserva-tipo-grupo-mini">
                      <span class="modalidad-nombre">{{ reserva.modalidad | titlecase }}</span>
                    </div>
                  </div>

                  <button class="btn-cancelar-admin" title="Cancelar reserva"
                    (click)="abrirModalCancelarAdmin(reserva)">
                    <span class="material-symbols-rounded">cancel</span>
                  </button>
                </div>
                }
              </div>
            </div>
            }
          </div>
          } @else {
          <div class="empty-state-modal">
            <span class="material-symbols-rounded">event_busy</span>
            <p>No hay reservas de grupo {{ tipoGrupoSeleccionado() }} para este día.</p>
          </div>
          }
          }
          } @else {
          <!-- VISTA CLIENTE -->

          @if (modoCambio()) {
          <!-- MODO CAMBIO: Mini-calendario de días -->
          <div class="modo-cambio-header">
            <button class="btn-volver-modal" (click)="cancelarModoCambio()">
              <span class="material-symbols-rounded">arrow_back</span>
              Volver
            </button>
            <div class="cambio-info">
              <span class="material-symbols-rounded">sync_alt</span>
              Cambiando clase del {{ formatearFechaCambio(reservaACambiar()!.fecha) }} - {{ reservaACambiar()!.hora }}
            </div>
          </div>

          @if (cargandoCambio()) {
          <div class="loading-state">
            <span class="spinner-small"></span>
            <p>Cargando sesiones disponibles...</p>
          </div>
          } @else if (diasConSesionesCambio().length > 0) {

          @if (!diaCambioSeleccionado()) {
          <!-- PASO 1: Mini-calendario de días con estructura semanal -->
          <h3 class="section-title">Selecciona un día</h3>
          <div class="mini-calendario-grid">
            <!-- Cabecera de días de la semana -->
            <div class="mini-calendario-header">
              <span class="dia-header-mini">Lun</span>
              <span class="dia-header-mini">Mar</span>
              <span class="dia-header-mini">Mié</span>
              <span class="dia-header-mini">Jue</span>
              <span class="dia-header-mini">Vie</span>
            </div>
            <!-- Filas por semana -->
            @for (semana of semanasCalendarioCambio(); track $index) {
            <div class="mini-calendario-semana">
              @for (dia of semana; track dia?.fecha ?? $index) {
              @if (dia) {
              <button type="button" class="dia-cambio-btn" [class.dia-festivo]="dia.esFestivo"
                [class.dia-pasado]="dia.esPasado" [class.dia-actual]="dia.esMismodia"
                [disabled]="dia.esFestivo || dia.esPasado" (click)="seleccionarDiaCambio(dia.fecha)">
                <span class="dia-numero">{{ dia.dia }}</span>
                @if (dia.esFestivo) {
                <span class="dia-estado dia-estado--festivo">
                  <span class="material-symbols-rounded">block</span>
                </span>
                }
              </button>
              } @else {
              <div class="dia-cambio-placeholder"></div>
              }
              }
            </div>
            }
          </div>
          <div class="leyenda-cambio">
            <span class="leyenda-item-cambio">
              <span class="leyenda-color leyenda-festivo-cambio"></span>
              Festivo (bloqueado)
            </span>
          </div>
          } @else {
          <!-- PASO 2: Turnos del día seleccionado -->
          <div class="cambio-dia-header">
            <button class="btn-volver-modal" (click)="volverAMiniCalendario()">
              <span class="material-symbols-rounded">arrow_back</span>
              Ver otros días
            </button>
            <span class="dia-seleccionado-badge">{{ formatearFechaCambio(diaCambioSeleccionado()!) }}</span>
          </div>

          <h3 class="section-title">Turnos disponibles</h3>
          <div class="lista-cambio-sesiones">
            @for (sesion of sesionesCambioDia(); track sesion.id) {
            <div class="cambio-sesion-card" [class.sesion-llena]="sesion.plazas_disponibles === 0"
              [class.es-misma-sesion]="sesion.id === reservaACambiar()!.sesion_id">

              <div class="cambio-sesion-info">
                <div class="cambio-hora">{{ sesion.hora }}</div>
                <div class="cambio-plazas" [class.plazas-disponibles]="sesion.plazas_disponibles > 0">
                  {{ sesion.plazas_disponibles }} plaza{{ sesion.plazas_disponibles !== 1 ? 's' : '' }} libre{{
                  sesion.plazas_disponibles !== 1 ? 's' : '' }}
                </div>
              </div>

              <div class="cambio-sesion-acciones">
                @if (sesion.id === reservaACambiar()!.sesion_id) {
                <span class="badge-actual">Sesión actual</span>
                } @else if (sesion.tiene_reserva) {
                <span class="badge-ya-tienes">Ya tienes clase</span>
                } @else if (sesion.plazas_disponibles > 0) {
                <button class="btn-seleccionar-cambio" [disabled]="guardando()"
                  (click)="confirmarCambioTurno(sesion.id)">
                  <span class="material-symbols-rounded">check_circle</span>
                  Cambiar aquí
                </button>
                } @else {
                <button class="btn-primario-espera btn-compact" [disabled]="guardando()"
                  (click)="apuntarseListaEspera(sesion.id)">
                  Avisar hueco
                </button>
                }
              </div>
            </div>
            }
          </div>
          }

          } @else {
          <div class="empty-state-modal">
            <span class="material-symbols-rounded">event_busy</span>
            <p>No hay sesiones disponibles para cambiar.</p>
          </div>
          }

          } @else {
          <!-- VISTA NORMAL: Solo la clase del cliente -->
          <h3 class="section-title">Tu clase</h3>
          @if (sesionesFiltradasPorGrupo().length > 0) {
          <div class="lista-reservas-detalle">
            @for (sesion of sesionesFiltradasPorGrupo(); track sesion.id) {
            <div class="reserva-detalle-card" [class.reserva-focus]="sesion.modalidad === 'focus'"
              [class.reserva-reducido]="sesion.modalidad === 'reducido'"
              [class.sesion-llena]="sesion.plazas_disponibles === 0 && !sesion.tiene_reserva">

              <!-- Left: Time and Type -->
              <div class="reserva-contenido">
                <div class="reserva-hora-destacada">{{ sesion.hora }}</div>
                <div class="reserva-tipo-grupo">
                  <span class="modalidad-icono material-symbols-rounded">
                    {{ sesion.modalidad === 'focus' ? 'fitness_center' : 'groups' }}
                  </span>
                  <span class="modalidad-nombre">{{ sesion.modalidad === 'focus' ? 'Focus' : 'Reducido' }}</span>
                </div>
              </div>

              <!-- Right: Status/Action -->
              <div class="reserva-acciones">
                @if (sesion.tiene_reserva) {
                <div class="tu-clase-acciones">
                  <div class="estado-badge estado-tu-reserva">
                    <span class="material-symbols-rounded">check_circle</span>
                    Tu clase
                  </div>
                  <div class="tu-clase-botones">
                    <button class="btn-cambiar-clase" [disabled]="guardando()"
                      (click)="iniciarCambio({ id: sesion.mi_reserva_id!, sesion_id: sesion.id, hora: sesion.hora }, diaSeleccionado()!.fecha, sesion.modalidad)">
                      <span class="material-symbols-rounded">sync_alt</span>
                      Cambiar
                    </button>
                    <button class="btn-cancelar-clase" [disabled]="guardando()"
                      (click)="cancelarReservaDesdeModal(sesion.mi_reserva_id!)">
                      <span class="material-symbols-rounded">cancel</span>
                      Cancelar
                    </button>
                  </div>
                </div>
                } @else if (sesion.en_lista_espera) {
                @if (sesion.plazas_disponibles > 0) {
                <div class="alerta-plaza-libre">
                  <span class="material-symbols-rounded">campaign</span>
                  ¡Plaza libre!
                </div>
                }
                <button class="btn-secundario-danger btn-compact" [disabled]="guardando()"
                  (click)="salirListaEspera(sesion.id)">
                  Salir espera
                </button>
                } @else if (sesion.plazas_disponibles === 0) {
                <button class="btn-primario-espera btn-compact" [disabled]="guardando()"
                  (click)="apuntarseListaEspera(sesion.id)">
                  Avisar hueco
                </button>
                } @else {
                <div class="estado-badge estado-libre">
                  {{ sesion.plazas_disponibles }} libres
                </div>
                }
              </div>
            </div>
            }
          </div>
          } @else {
          <div class="empty-state-modal">
            <p class="no-reservas">No tienes clase reservada este día.</p>
          </div>
          }
          }
          }
          }
        </div>
      </div>
    </div>
    }
  </div>
  }

  <!-- Modal Confirmación Cierre con Conflictos -->
  @if (mostrarModalConfirmacion()) {
  <div class="modal-overlay modal-danger">
    <div class="modal-confirmacion">
      <header class="modal-header header-danger">
        <span class="material-symbols-rounded icon-warn">warning</span>
        <h3>¡Atención! Conflictos detectados</h3>
      </header>

      <div class="modal-body">
        <p class="warn-text">Has marcado días festivos que contienen reservas activas. Si continúas:</p>

        <ul class="lista-conflictos">
          @for (conflicto of conflictosCierre(); track conflicto.fecha) {
          <li>
            <span class="conflicto-fecha">{{ conflicto.fecha | date:'dd/MM/yyyy' }}</span>
            <span class="conflicto-count">{{ conflicto.numReservas }} reserva(s)</span>
          </li>
          }
        </ul>

        <p class="warn-subtext">Se cancelarán estas reservas y se notificará a los usuarios generando recuperaciones.
        </p>
      </div>

      <div class="modal-footer">
        <button class="btn-cancelar" (click)="cancelarCierre()">Cancelar</button>
        <button class="btn-confirmar-peligro" (click)="confirmarCierreConConflictos()">
          Entendido, cerrar día
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Modal Cancelar Reserva Admin -->
  @if (mostrarModalCancelarAdmin()) {
  <div class="modal-overlay modal-danger" (click)="cerrarModalCancelarAdmin()">
    <div class="modal-confirmacion modal-cancelar-admin" (click)="$event.stopPropagation()">
      <header class="modal-header header-danger">
        <span class="material-symbols-rounded icon-warn">warning</span>
        <h3>Cancelar Reserva</h3>
        <button class="btn-cerrar" (click)="cerrarModalCancelarAdmin()" aria-label="Cerrar">
          <span class="material-symbols-rounded">close</span>
        </button>
      </header>

      <div class="modal-body">
        <div class="info-reserva-cancelar">
          <p class="reserva-usuario">
            <span class="material-symbols-rounded">person</span>
            {{ reservaACancelarAdmin()?.usuario_nombre }}
          </p>
          <p class="reserva-detalles">
            <span class="material-symbols-rounded">schedule</span>
            {{ reservaACancelarAdmin()?.hora }} - {{ reservaACancelarAdmin()?.modalidad | titlecase }}
          </p>
        </div>

        <div class="opciones-cancelacion">
          <p class="opciones-titulo">¿Cómo deseas proceder?</p>

          <button class="btn-opcion btn-opcion--recuperacion" [disabled]="cancelandoAdmin()"
            (click)="cancelarReservaAdmin(true)">
            @if (cancelandoAdmin()) {
            <span class="spinner-small"></span>
            } @else {
            <span class="material-symbols-rounded">refresh</span>
            }
            <div class="opcion-texto">
              <strong>Cancelar con recuperación</strong>
              <span>Se generará una recuperación para el usuario</span>
            </div>
          </button>

          <button class="btn-opcion btn-opcion--permanente" [disabled]="cancelandoAdmin()"
            (click)="cancelarReservaAdmin(false)">
            @if (cancelandoAdmin()) {
            <span class="spinner-small"></span>
            } @else {
            <span class="material-symbols-rounded">delete_forever</span>
            }
            <div class="opcion-texto">
              <strong>Eliminar permanentemente</strong>
              <span>No se generará recuperación</span>
            </div>
          </button>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancelar" (click)="cerrarModalCancelarAdmin()" [disabled]="cancelandoAdmin()">
          Volver
        </button>
      </div>
    </div>
  </div>
  }
</main>