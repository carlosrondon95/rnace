<!-- src/app/components/dashboard/dashboard.component.html -->
<main class="dashboard-page">
  <div class="dashboard-container">
    <!-- Header -->
    <header class="welcome-section">
      <div class="welcome-content">
        <h1>{{ saludo() }}, {{ nombreUsuario() }}</h1>
        <p class="welcome-subtitle">
          @if (isCliente()) {
          Tu espacio de bienestar
          } @else if (isProfesor()) {
          Panel de profesor
          } @else {
          Panel de administración
          }
        </p>
      </div>

      <!-- Botón notificaciones -->
      <button type="button" class="btn-notificaciones" (click)="irANotificaciones()" aria-label="Ver notificaciones">
        <span class="material-symbols-rounded">notifications</span>
        @if (notificacionesNoLeidas() > 0) {
        <span class="notif-badge">{{ notificacionesNoLeidas() }}</span>
        }
      </button>
    </header>

    <!-- Prompt de instalación PWA y notificaciones -->
    <app-notification-prompt></app-notification-prompt>

    <!-- ==================== CLIENTE ==================== -->
    @if (isCliente()) {
    <!-- Próximas clases - STACK CARDS -->
    <section class="section">
      <div class="section-header">
        <h2>
          <span class="material-symbols-rounded">event</span>
          Próximas clases
        </h2>
        <a routerLink="/calendario" class="link-ver-mas">Ver todas</a>
      </div>

      @if (cargando()) {
      <div class="loading-inline">
        <div class="spinner-small"></div>
        <span>Cargando...</span>
      </div>
      } @else if (proximasClases().length === 0) {
      <div class="empty-card">
        <span class="material-symbols-rounded">event_busy</span>
        <p>No tienes clases programadas</p>
      </div>
      } @else {
      <!-- Stack de cards -->
      <div class="stack-container">
        <div class="stack-wrapper" [class.stack-expanded]="stackExpanded()" (click)="toggleStack()">

          @for (clase of proximasClases(); track trackByClaseId($index, clase); let i = $index) {
          <article class="stack-card" [class.stack-card--active]="i === activeStackIndex()"
            [class.stack-card--recuperacion]="clase.es_recuperacion" [style.--stack-index]="i"
            [attr.aria-hidden]="i !== activeStackIndex()">

            <!-- Badge superior -->
            <div class="stack-card__header">
              @if (i === 0) {
              <span class="temporal-badge temporal-badge--next">Próxima clase</span>
              } @else {
              <span class="temporal-badge">En {{ getDiasHasta(clase) }}</span>
              }
              @if (clase.es_recuperacion) {
              <span class="tag-recuperacion">
                <span class="material-symbols-rounded">replay</span>
                Recuperación
              </span>
              }
            </div>

            <!-- Contenido principal con layout horizontal -->
            <div class="stack-card__body">
              <!-- Fecha grande a la izquierda -->
              <div class="stack-card__date-block">
                <span class="date-number">{{ clase.fecha }}</span>
                <span class="date-day">{{ clase.dia_nombre }}</span>
              </div>

              <!-- Separador visual -->
              <div class="stack-card__divider"></div>

              <!-- Info derecha -->
              <div class="stack-card__info">
                <div class="stack-card__time">
                  <span class="material-symbols-rounded">schedule</span>
                  <span>{{ clase.hora }}</span>
                </div>
                <span class="modalidad-pill" [class]="'modalidad-pill--' + clase.modalidad">
                  {{ clase.modalidad }}
                </span>
              </div>
            </div>
          </article>
          }
        </div>

        <!-- Indicadores de posición -->
        @if (proximasClases().length > 1) {
        <div class="stack-indicators">
          @for (clase of proximasClases(); track trackByClaseId($index, clase); let i = $index) {
          <button type="button" class="stack-dot" [class.stack-dot--active]="i === activeStackIndex()"
            (click)="setActiveStackIndex(i); $event.stopPropagation()" [attr.aria-label]="'Ver clase ' + (i + 1)">
          </button>
          }
        </div>
        }

        <!-- Hint de navegación -->
        @if (proximasClases().length > 1 && !stackExpanded()) {
        <p class="stack-hint">
          <span class="material-symbols-rounded">touch_app</span>
          Toca para ver todas
        </p>
        }
      </div>
      }
    </section>

    <!-- Recuperaciones disponibles -->
    @if (tieneRecuperaciones()) {
    <section class="section section--highlight">
      <div class="section-header">
        <h2>
          <span class="material-symbols-rounded">replay</span>
          Recuperaciones disponibles
        </h2>
      </div>

      <div class="recuperaciones-lista">
        @for (recup of recuperaciones(); track trackByRecupId($index, recup)) {
        <div class="recuperacion-card">
          <div class="recuperacion-info">
            <span class="recuperacion-modalidad" [class]="'modalidad--' + recup.modalidad">
              {{ recup.modalidad }}
            </span>
            <span class="recuperacion-expira">
              {{ getTextoValidez(recup) }}
            </span>
          </div>
          @if (esRecuperacionFutura(recup)) {
          <a [routerLink]="['/recuperar-clase']" [queryParams]="{ mes: recup.mes_origen, anio: recup.anio_origen }"
            class="btn-usar">
            Usar
            <span class="material-symbols-rounded">arrow_forward</span>
          </a>
          } @else {
          <a routerLink="/recuperar-clase" class="btn-usar">
            Usar
            <span class="material-symbols-rounded">arrow_forward</span>
          </a>
          }
        </div>
        }
      </div>
    </section>
    }

    <!-- Acciones rápidas cliente -->
    <section class="actions-grid">
      <a routerLink="/calendario" class="action-card action-card--primary">
        <span class="action-icon material-symbols-rounded">calendar_month</span>
        <div class="action-content">
          <h3>Mis clases</h3>
          <p>Ver mi calendario</p>
        </div>
        <span class="action-arrow material-symbols-rounded">arrow_forward</span>
      </a>

      <a routerLink="/recuperar-clase" class="action-card">
        <span class="action-icon material-symbols-rounded">replay</span>
        <div class="action-content">
          <h3>Recuperar clase</h3>
          <p>Usar recuperación</p>
        </div>
        <span class="action-arrow material-symbols-rounded">arrow_forward</span>
      </a>
    </section>
    }

    <!-- ==================== PROFESOR ==================== -->
    @if (isProfesor()) {
    <section class="actions-grid">
      <a routerLink="/calendario" class="action-card action-card--primary">
        <span class="action-icon material-symbols-rounded">calendar_month</span>
        <div class="action-content">
          <h3>Mi calendario</h3>
          <p>Ver clases programadas</p>
        </div>
        <span class="action-arrow material-symbols-rounded">arrow_forward</span>
      </a>
    </section>
    }

    <!-- ==================== ADMIN ==================== -->
    @if (isAdmin()) {
    <!-- Estadísticas del día -->
    <section class="section">
      <div class="section-header clickable" (click)="toggleHoySection()">
        <h2>
          <span class="material-symbols-rounded">analytics</span>
          Hoy
        </h2>
        <span class="material-symbols-rounded chevron" [class.rotated]="!hoyExpanded()">expand_more</span>
      </div>

      @if (hoyExpanded()) {
      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-value">{{ estadisticas().clases_hoy }}</span>
          <span class="stat-label">Clases</span>
        </div>
        <div class="stat-card">
          <span class="stat-value">{{ estadisticas().alumnos_hoy }}</span>
          <span class="stat-label">Alumnos</span>
        </div>
        <div class="stat-card">
          <span class="stat-value">{{ estadisticas().plazas_disponibles }}</span>
          <span class="stat-label">Plazas libres</span>
        </div>
        <div class="stat-card stat-card--warning">
          <span class="stat-value">{{ estadisticas().en_lista_espera }}</span>
          <span class="stat-label">En espera</span>
        </div>
      </div>
      }
    </section>

    <!-- Clases de hoy - CARDS EXPANDIBLES CON BARRA DE PROGRESO -->
    <section class="section">
      <div class="section-header clickable" (click)="toggleClasesHoySection()">
        <h2>
          <span class="material-symbols-rounded">schedule</span>
          Clases de hoy
        </h2>
        <span class="material-symbols-rounded chevron" [class.rotated]="!clasesHoyExpanded()">expand_more</span>
      </div>

      @if (clasesHoyExpanded()) {
      @if (clasesHoy().length > 0) {
      <div class="clases-timeline">
        @for (clase of clasesHoy(); track trackByClaseId($index, clase); let i = $index) {
        <article class="timeline-card" [class.timeline-card--expanded]="expandedClaseIndex() === i"
          [class.timeline-card--full]="clase.reservas_count >= clase.capacidad" (click)="toggleClaseExpand(i)">

          <!-- Header compacto -->
          <div class="timeline-card__header">
            <div class="timeline-card__time">
              <span class="material-symbols-rounded">schedule</span>
              {{ clase.hora }}
            </div>

            <span class="modalidad-chip" [class]="'modalidad-chip--' + clase.modalidad">
              {{ clase.modalidad }}
            </span>

            <div class="timeline-card__ocupacion">
              <span class="ocupacion-texto">{{ clase.reservas_count }}/{{ clase.capacidad }}</span>
              <span class="material-symbols-rounded expand-icon"
                [class.expand-icon--rotated]="expandedClaseIndex() === i">
                expand_more
              </span>
            </div>
          </div>

          <!-- Barra de progreso -->
          <div class="progress-container">
            <div class="progress-bar" [class.progress-bar--low]="getOcupacionPercent(clase) < 50"
              [class.progress-bar--medium]="getOcupacionPercent(clase) >= 50 && getOcupacionPercent(clase) < 85"
              [class.progress-bar--high]="getOcupacionPercent(clase) >= 85"
              [class.progress-bar--full]="clase.reservas_count >= clase.capacidad"
              [style.--progress-width]="getOcupacionPercent(clase) + '%'">
            </div>
          </div>

          <!-- Contenido expandible -->
          <div class="timeline-card__body" [class.timeline-card__body--visible]="expandedClaseIndex() === i">
            @if (clase.alumnos.length > 0) {
            <div class="alumnos-grid">
              @for (alumno of clase.alumnos; track alumno) {
              <div class="alumno-item">
                <span class="material-symbols-rounded">person</span>
                {{ alumno }}
              </div>
              }
            </div>
            } @else {
            <p class="no-alumnos">
              <span class="material-symbols-rounded">event_busy</span>
              Sin reservas aún
            </p>
            }
          </div>
        </article>
        }
      </div>
      } @else {
      <div class="empty-card">
        <span class="material-symbols-rounded">event_busy</span>
        <p>No hay más clases programadas para hoy</p>
      </div>
      }
      }
    </section>

    <!-- Acciones admin -->
    <section class="actions-grid actions-grid--admin">
      <a routerLink="/gestionar-perfiles" class="action-card action-card--primary">
        <span class="action-icon material-symbols-rounded">manage_accounts</span>
        <div class="action-content">
          <h3>Gestionar perfiles</h3>
          <p>Usuarios y horarios</p>
        </div>
        <span class="action-arrow material-symbols-rounded">arrow_forward</span>
      </a>

      <a routerLink="/calendario" class="action-card">
        <span class="action-icon material-symbols-rounded">calendar_month</span>
        <div class="action-content">
          <h3>Calendario</h3>
          <p>Meses y festivos</p>
        </div>
        <span class="action-arrow material-symbols-rounded">arrow_forward</span>
      </a>

      <a routerLink="/admin-reservas" class="action-card">
        <span class="action-icon material-symbols-rounded">event_note</span>
        <div class="action-content">
          <h3>Reservas</h3>
          <p>Ver todas las reservas</p>
        </div>
        <span class="action-arrow material-symbols-rounded">arrow_forward</span>
      </a>

      <a routerLink="/lista-espera" class="action-card">
        <span class="action-icon material-symbols-rounded">hourglass_top</span>
        <div class="action-content">
          <h3>Lista de espera</h3>
          <p>Gestionar cola</p>
        </div>
        <span class="action-arrow material-symbols-rounded">arrow_forward</span>
      </a>
    </section>
    }

    <!-- Info usuario -->
    <section class="user-info">
      <div class="user-info-card">
        <span class="user-info-icon material-symbols-rounded">person</span>
        <div class="user-info-content">
          <span class="user-info-label">Tu cuenta</span>
          <span class="user-info-value">{{ auth.usuario()?.telefono }}</span>
        </div>
        <span [ngClass]="getRoleBadgeClass()">
          {{ getRoleLabel() }}
        </span>
      </div>
    </section>
  </div>
</main>